<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Spring-IOC-从单例缓存中获取单例 Bean | Recording</title><meta name=Description content="recording my life"><meta property="og:title" content="Spring-IOC-从单例缓存中获取单例 Bean"><meta property="og:description" content="1 getSingleton 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 //DefaultSingletonBeanRegistry.java public Object getSingleton(String beanName) { // allowEarlyReference 参数，allowEarlyReference 表示是否允"><meta property="og:type" content="article"><meta property="og:url" content="https://cool-sen.github.io/posts/ioc-get-bean-getsingleton/"><meta property="article:published_time" content="2020-04-18T18:34:57+08:00"><meta property="article:modified_time" content="2020-04-18T18:34:57+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Spring-IOC-从单例缓存中获取单例 Bean"><meta name=twitter:description content="1 getSingleton 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 //DefaultSingletonBeanRegistry.java public Object getSingleton(String beanName) { // allowEarlyReference 参数，allowEarlyReference 表示是否允"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=canonical href=https://cool-sen.github.io/posts/ioc-get-bean-getsingleton/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=prev href=https://cool-sen.github.io/posts/ioc-get-bean-1/><link rel=next href=https://cool-sen.github.io/posts/template/><link href=https://cdn.staticfile.org/font-awesome/5.12.1/css/all.min.css rel=stylesheet><link href=https://cdn.staticfile.org/animate.css/3.7.2/animate.css rel=stylesheet><link rel=stylesheet href=/css/style.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Spring-IOC-从单例缓存中获取单例 Bean","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/cool-sen.github.io\/posts\/ioc-get-bean-getsingleton\/"},"image":{"@type":"ImageObject","url":"https:\/\/cool-sen.github.io\/","width":800,"height":600},"genre":"posts","keywords":"Spring, IOC","wordcount":2793,"url":"https:\/\/cool-sen.github.io\/posts\/ioc-get-bean-getsingleton\/","datePublished":"2020-04-18","dateModified":"2020-04-18","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"ZhaoQiang","logo":{"@type":"ImageObject","url":"https:\/\/cool-sen.github.io\/","width":127,"height":40}},"author":{"@type":"Person","name":"shuaisenma"},"description":""}</script></head><body><script>if(!window.localStorage||!window.localStorage.getItem('theme')){window.isDark=window.matchMedia('(prefers-color-scheme: dark)').matches;}else{window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';}
window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/>Recording</a></div><div class=menu><a class=menu-item href=/posts rel="noopener noreffer">文章</a><a class=menu-item href=/tags rel="noopener noreffer">标签</a><a class=menu-item href=/categories rel="noopener noreffer">分类</a><a class=menu-item href=/about rel="noopener noreffer">关于</a><span class=menu-item>|</span>
<a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></header><header class=mobile id=header-mobile><div class=header-wrapper><div class=header-container><div class=header-title><a href=/>Recording</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts rel="noopener noreffer">文章</a><a class=menu-item href=/tags rel="noopener noreffer">标签</a><a class=menu-item href=/categories rel="noopener noreffer">分类</a><a class=menu-item href=/about rel="noopener noreffer">关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><script>window.desktopHeaderMode="fixed";window.mobileHeaderMode="auto";</script><main class=main><div class=container><article class="page single"><h1 class="single-title animated flipInX">Spring-IOC-从单例缓存中获取单例 Bean</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>shuaisenma</a>
</span>&nbsp;
<span class=post-category>收录于<a href=/categories/spring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90>
<i class="far fa-folder fa-fw"></i>Spring源码分析</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-04-18>2020-04-18</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>约 2793 字&nbsp;
<i class="far fa-clock fa-fw"></i>预计阅读 6 分钟&nbsp;<span id=/posts/ioc-get-bean-getsingleton/ class=leancloud_visitors data-flag-title="Spring-IOC-从单例缓存中获取单例 Bean">
<i class="far fa-eye fa-fw"></i><span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div></div><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><div class=toc id=toc-static><details><summary><div class=toc-title><span>目录</span>
<span><i class="details icon fas fa-angle-down"></i></span></div></summary><div class=toc-content id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-getsingleton>1 <code>getSingleton</code></a></li><li><a href=#2-getobjectforbeaninstance>2 <code>getObjectForBeanInstance</code></a><ul><li><a href=#21-getobjectfromfactorybean>2.1 <code>getObjectFromFactoryBean</code></a></li><li><a href=#22-dogetobjectfromfactorybean>2.2 <code>doGetObjectFromFactoryBean</code></a></li><li><a href=#23-issingletoncurrentlyincreation>2.3 <code>isSingletonCurrentlyInCreation</code></a></li><li><a href=#24-postprocessobjectfromfactorybean>2.4 <code>postProcessObjectFromFactoryBean</code></a></li></ul></li></ul></nav></div></details></div><div class=content id=content><h2 id=1-getsingleton>1 <code>getSingleton</code></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>//DefaultSingletonBeanRegistry.java
</span><span class=c1></span>
<span class=kd>public</span> <span class=n>Object</span> <span class=nf>getSingleton</span><span class=o>(</span><span class=n>String</span> <span class=n>beanName</span><span class=o>)</span> <span class=o>{</span>
    	<span class=c1>// allowEarlyReference 参数，allowEarlyReference 表示是否允许其他 bean 引用
</span><span class=c1></span>    	<span class=c1>// 参数true设置标识允许早期依赖
</span><span class=c1></span>		<span class=k>return</span> <span class=n>getSingleton</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
	<span class=o>}</span>

<span class=nd>@Nullable</span>
<span class=kd>protected</span> <span class=n>Object</span> <span class=nf>getSingleton</span><span class=o>(</span><span class=n>String</span> <span class=n>beanName</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>allowEarlyReference</span><span class=o>)</span> <span class=o>{</span>
		<span class=c1>// &lt;1&gt; 从单例缓存中加载 bean
</span><span class=c1></span>		<span class=n>Object</span> <span class=n>singletonObject</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>singletonObjects</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
		<span class=c1>// 缓存中的 bean 为空，且当前 bean 正在创建
</span><span class=c1></span>		<span class=k>if</span> <span class=o>(</span><span class=n>singletonObject</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>isSingletonCurrentlyInCreation</span><span class=o>(</span><span class=n>beanName</span><span class=o>))</span> <span class=o>{</span>
			<span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>singletonObjects</span><span class=o>)</span> <span class=o>{</span>
				<span class=c1>// &lt;2&gt; 从 earlySingletonObjects 获取
</span><span class=c1></span>				<span class=n>singletonObject</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>earlySingletonObjects</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
				<span class=c1>// earlySingletonObjects 中没有，且允许提前创建
</span><span class=c1></span>				<span class=k>if</span> <span class=o>(</span><span class=n>singletonObject</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>allowEarlyReference</span><span class=o>)</span> <span class=o>{</span>
					<span class=c1>// &lt;3&gt; 从 singletonFactories 中获取对应的 ObjectFactory
</span><span class=c1></span>					<span class=n>ObjectFactory</span><span class=o>&lt;?&gt;</span> <span class=n>singletonFactory</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>singletonFactories</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
					<span class=k>if</span> <span class=o>(</span><span class=n>singletonFactory</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
						<span class=n>singletonObject</span> <span class=o>=</span> <span class=n>singletonFactory</span><span class=o>.</span><span class=na>getObject</span><span class=o>();</span>
						<span class=c1>// 添加 bean 到 earlySingletonObjects 中
</span><span class=c1></span>						<span class=k>this</span><span class=o>.</span><span class=na>earlySingletonObjects</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=n>singletonObject</span><span class=o>);</span>
						<span class=c1>// 从 singletonFactories 中移除对应的 ObjectFactory
</span><span class=c1></span>						<span class=k>this</span><span class=o>.</span><span class=na>singletonFactories</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
					<span class=o>}</span>
				<span class=o>}</span>
			<span class=o>}</span>
		<span class=o>}</span>
		<span class=k>return</span> <span class=n>singletonObject</span><span class=o>;</span>
	<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>上面代码的分析:</p><ol><li>&lt;1> 处，从 <code>singletonObjects</code> 中，获取 Bean 对象。</li><li>&lt;2> 处，若为空且当前 bean 正在创建中，则从 <code>earlySingletonObjects</code> 中获取 Bean 对象。</li><li>&lt;3> 处，若为空且允许提前创建，则从 <code>singletonFactories</code> 中获取相应的 <code>ObjectFactory</code> 对象。若<code>ObjectFactory</code> 不为空，则调用其 <code>ObjectFactory#getObject(String name)</code> 方法，创建 Bean 对象，然后将其加入到 <code>earlySingletonObjects</code> ，然后从 <code>singletonFactories</code> 删除。</li></ol><p>上面代码涉及到了好几个缓存集合，补充一下这几个缓存集合的作用。</p><ul><li>缓存集合的定义：</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>//DefaultSingletonBeanRegistry.java
</span><span class=c1></span>
<span class=cm>/** 存放的是单例 bean 的映射。对应关系为 bean name --&gt; bean instance */</span>
<span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>singletonObjects</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;(</span><span class=n>256</span><span class=o>);</span>

<span class=cm>/** 
</span><span class=cm>存放的是早期的 bean，对应关系也是 bean name --&gt; bean instance  
</span><span class=cm>与singletonObjects的不同之处在于，当一个单例bean被放到这里面后，那么当bean还在创建过程中，就可以通过getBean方法获取到了，其目的是用来检测循环引用。
</span><span class=cm>*/</span>
<span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>earlySingletonObjects</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;(</span><span class=n>16</span><span class=o>);</span>

<span class=cm>/** 存放的是 ObjectFactory。对应关系是 bean name --&gt; ObjectFactory */</span>
<span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>ObjectFactory</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>singletonFactories</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;(</span><span class=n>16</span><span class=o>);</span>
</code></pre></td></tr></table></div></div><ul><li>缓存集合的用途：</li></ul><table><thead><tr><th align=left>缓存</th><th align=left>用途</th></tr></thead><tbody><tr><td align=left><code>singletonObjects</code></td><td align=left>用于存放完全初始化好的 bean，从该缓存中取出的 bean 可以直接使用</td></tr><tr><td align=left><code>earlySingletonObjects</code></td><td align=left>用于存放还在初始化中的 bean，用于解决循环依赖</td></tr><tr><td align=left><code>singletonFactories</code></td><td align=left>用于存放 bean 工厂。bean 工厂所产生的 bean 是还未完成初始化的 bean。如代码所示，bean 工厂所生成的对象最终会被缓存到<code>earlySingletonObjects</code>中</td></tr></tbody></table><h2 id=2-getobjectforbeaninstance>2 <code>getObjectForBeanInstance</code></h2><p>代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>// AbstractBeanFactory.java
</span><span class=c1></span>
<span class=kd>protected</span> <span class=n>Object</span> <span class=nf>getObjectForBeanInstance</span><span class=o>(</span>
        <span class=n>Object</span> <span class=n>beanInstance</span><span class=o>,</span> <span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>String</span> <span class=n>beanName</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>RootBeanDefinition</span> <span class=n>mbd</span><span class=o>)</span> <span class=o>{</span>

    <span class=c1>// &lt;1&gt; 若为工厂类引用（name 以 &amp; 开头）
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>BeanFactoryUtils</span><span class=o>.</span><span class=na>isFactoryDereference</span><span class=o>(</span><span class=n>name</span><span class=o>))</span> <span class=o>{</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>beanInstance</span> <span class=k>instanceof</span> <span class=n>NullBean</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>return</span> <span class=n>beanInstance</span><span class=o>;</span>
        <span class=o>}</span>
        <span class=c1>// 如果 beanInstance 不是 FactoryBean 类型，则抛出异常
</span><span class=c1></span>        <span class=k>if</span> <span class=o>(!(</span><span class=n>beanInstance</span> <span class=k>instanceof</span> <span class=n>FactoryBean</span><span class=o>))</span> <span class=o>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>BeanIsNotAFactoryException</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=n>beanInstance</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
        <span class=o>}</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>mbd</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>mbd</span><span class=o>.</span><span class=na>isFactoryBean</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
        <span class=o>}</span>
        <span class=k>return</span> <span class=n>beanInstance</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=c1>// &lt;2&gt; beanInstance 不为 FactoryBean 类型，则直接返回
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(!(</span><span class=n>beanInstance</span> <span class=k>instanceof</span> <span class=n>FactoryBean</span><span class=o>))</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>beanInstance</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=n>Object</span> <span class=n>object</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
    <span class=c1>// &lt;3&gt; 若 BeanDefinition 为 null，则从缓存中加载 Bean 对象
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>mbd</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>mbd</span><span class=o>.</span><span class=na>isFactoryBean</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
    <span class=o>}</span>
    <span class=k>else</span> <span class=o>{</span>
        <span class=n>object</span> <span class=o>=</span> <span class=n>getCachedObjectForFactoryBean</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
    <span class=o>}</span>
    <span class=c1>// 若 object 依然为空，则beanInstance 一定是 FactoryBean 
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>object</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>FactoryBean</span><span class=o>&lt;?&gt;</span> <span class=n>factory</span> <span class=o>=</span> <span class=o>(</span><span class=n>FactoryBean</span><span class=o>&lt;?&gt;)</span> <span class=n>beanInstance</span><span class=o>;</span>
        <span class=c1>// containsBeanDefinition在所有已经加载的类中检测是否定义 beanName
</span><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>mbd</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>containsBeanDefinition</span><span class=o>(</span><span class=n>beanName</span><span class=o>))</span> <span class=o>{</span>
            <span class=c1>// 将存储 XML 配置文件的 GenericBeanDefinition 转换为 RootBeanDefinition，
</span><span class=c1></span>            <span class=c1>// 如果指定 BeanName 是子 Bean 的话同时会合并父类的相关属性
</span><span class=c1></span>            <span class=n>mbd</span> <span class=o>=</span> <span class=n>getMergedLocalBeanDefinition</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
        <span class=o>}</span>
        <span class=c1>// 是否是用户定义的，而不是应用程序本身定义的
</span><span class=c1></span>        <span class=kt>boolean</span> <span class=n>synthetic</span> <span class=o>=</span> <span class=o>(</span><span class=n>mbd</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>mbd</span><span class=o>.</span><span class=na>isSynthetic</span><span class=o>());</span>
        <span class=c1>// 核心处理方法，使用 FactoryBean 获得 Bean 对象
</span><span class=c1></span>        <span class=n>object</span> <span class=o>=</span> <span class=n>getObjectFromFactoryBean</span><span class=o>(</span><span class=n>factory</span><span class=o>,</span> <span class=n>beanName</span><span class=o>,</span> <span class=o>!</span><span class=n>synthetic</span><span class=o>);</span>
    <span class=o>}</span>
    <span class=k>return</span> <span class=n>object</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>上面代码主要是做检测工作，核心在于委托给<code>getObjectFromFactoryBean</code>获得 Bean 对象，主要如下：</p><ol><li><code>&lt;1></code> 处，若 <code>name</code> 为工厂相关的（以 & 开头），且 <code>beanInstance</code> 为 <code>NullBean</code> 类型则直接返回，如果 <code>beanInstance</code> 不为 <code>FactoryBean</code> 类型则抛出 <code>BeanIsNotAFactoryException</code> 异常。这里主要是<strong>校验</strong> <code>beanInstance</code> 的<strong>正确性</strong>。</li><li><code>&lt;2></code> 处，如果 <code>beanInstance</code> 不为 <code>FactoryBean</code> 类型或者 <code>name</code> 也不是与工厂相关的，则直接返回 <code>beanInstance</code> 这个 Bean 对象。<strong>这里主要是对非 <code>FactoryBean</code> 类型处理</strong>。</li><li><code>&lt;3></code> 处，如果 <code>BeanDefinition</code> 为空，则从 <code>factoryBeanObjectCache</code> 中加载 Bean 对象(对应代码36行)。如果还是空，则 <code>beanInstance</code> 一定是<code> FactoryBean</code> 类型，则委托 <code>#getObjectFromFactoryBean(FactoryBean factory, String beanName, boolean shouldPostProcess)</code> 方法，进行处理，<strong>使用 <code>FactoryBean </code>获得 Bean 对象</strong>。</li></ol><h3 id=21-getobjectfromfactorybean>2.1 <code>getObjectFromFactoryBean</code></h3><p><code>getObjectFromFactoryBean</code>方法代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>// FactoryBeanRegistrySupport.java
</span><span class=c1></span>
<span class=kd>protected</span> <span class=n>Object</span> <span class=nf>getObjectFromFactoryBean</span><span class=o>(</span><span class=n>FactoryBean</span><span class=o>&lt;?&gt;</span> <span class=n>factory</span><span class=o>,</span> <span class=n>String</span> <span class=n>beanName</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>shouldPostProcess</span><span class=o>)</span> <span class=o>{</span>
    <span class=c1>// 为单例模式且在缓存中存在
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>factory</span><span class=o>.</span><span class=na>isSingleton</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=n>containsSingleton</span><span class=o>(</span><span class=n>beanName</span><span class=o>))</span> <span class=o>{</span>
        <span class=c1>// &lt;1&gt; 单例锁
</span><span class=c1></span>        <span class=kd>synchronized</span> <span class=o>(</span><span class=n>getSingletonMutex</span><span class=o>())</span> <span class=o>{</span>
            <span class=c1>// 从缓存中获取指定的 factoryBean
</span><span class=c1></span>            <span class=n>Object</span> <span class=n>object</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>factoryBeanObjectCache</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>object</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
                <span class=c1>// &lt;2&gt; 缓存为空，则从 FactoryBean 中获取对象
</span><span class=c1></span>                <span class=n>object</span> <span class=o>=</span> <span class=n>doGetObjectFromFactoryBean</span><span class=o>(</span><span class=n>factory</span><span class=o>,</span> <span class=n>beanName</span><span class=o>);</span>
                <span class=n>Object</span> <span class=n>alreadyThere</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>factoryBeanObjectCache</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
                <span class=k>if</span> <span class=o>(</span><span class=n>alreadyThere</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>object</span> <span class=o>=</span> <span class=n>alreadyThere</span><span class=o>;</span>
                <span class=o>}</span>
                <span class=k>else</span> <span class=o>{</span>
                    <span class=c1>// &lt;3&gt; 需要后续处理
</span><span class=c1></span>                    <span class=k>if</span> <span class=o>(</span><span class=n>shouldPostProcess</span><span class=o>)</span> <span class=o>{</span>
                        <span class=c1>// 若该 Bean 处于创建中，则返回非处理对象，而不是存储它
</span><span class=c1></span>                        <span class=k>if</span> <span class=o>(</span><span class=n>isSingletonCurrentlyInCreation</span><span class=o>(</span><span class=n>beanName</span><span class=o>))</span> <span class=o>{</span>
                            <span class=k>return</span> <span class=n>object</span><span class=o>;</span>
                        <span class=o>}</span>
                        <span class=c1>// 单例 Bean 的前置处理
</span><span class=c1></span>                        <span class=n>beforeSingletonCreation</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
                        <span class=k>try</span> <span class=o>{</span>
                            <span class=c1>// 对从 FactoryBean 获取的对象进行后处理
</span><span class=c1></span>                            <span class=c1>// 将生成的对象将暴露给 bean 引用
</span><span class=c1></span>                            <span class=n>object</span> <span class=o>=</span> <span class=n>postProcessObjectFromFactoryBean</span><span class=o>(</span><span class=n>object</span><span class=o>,</span> <span class=n>beanName</span><span class=o>);</span>
                        <span class=o>}</span>
                        <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
                            <span class=k>throw</span> <span class=k>new</span> <span class=n>BeanCreationException</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span>
                                    <span class=s>&#34;Post-processing of FactoryBean&#39;s singleton object failed&#34;</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
                        <span class=o>}</span>
                        <span class=k>finally</span> <span class=o>{</span>
                            <span class=c1>// 单例 Bean 的后置处理
</span><span class=c1></span>                            <span class=n>afterSingletonCreation</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
                        <span class=o>}</span>
                    <span class=o>}</span>
                    <span class=c1>// &lt;1.4&gt; 添加到 factoryBeanObjectCache 中，进行缓存
</span><span class=c1></span>                    <span class=k>if</span> <span class=o>(</span><span class=n>containsSingleton</span><span class=o>(</span><span class=n>beanName</span><span class=o>))</span> <span class=o>{</span>
                        <span class=k>this</span><span class=o>.</span><span class=na>factoryBeanObjectCache</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=n>object</span><span class=o>);</span>
                    <span class=o>}</span>
                <span class=o>}</span>
            <span class=o>}</span>
            <span class=k>return</span> <span class=n>object</span><span class=o>;</span>
        <span class=o>}</span>
    <span class=o>}</span>
    <span class=k>else</span> <span class=o>{</span>
        <span class=c1>// 从 FactoryBean 中获取对象
</span><span class=c1></span>        <span class=n>Object</span> <span class=n>object</span> <span class=o>=</span> <span class=n>doGetObjectFromFactoryBean</span><span class=o>(</span><span class=n>factory</span><span class=o>,</span> <span class=n>beanName</span><span class=o>);</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>shouldPostProcess</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>try</span> <span class=o>{</span>
                <span class=n>object</span> <span class=o>=</span> <span class=n>postProcessObjectFromFactoryBean</span><span class=o>(</span><span class=n>object</span><span class=o>,</span> <span class=n>beanName</span><span class=o>);</span>
            <span class=o>}</span>
            <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
                <span class=k>throw</span> <span class=k>new</span> <span class=n>BeanCreationException</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=s>&#34;Post-processing of FactoryBean&#39;s object failed&#34;</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
            <span class=o>}</span>
        <span class=o>}</span>
        <span class=k>return</span> <span class=n>object</span><span class=o>;</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>上面代码的主要工作：</p><ol><li><p><code>&lt;1></code>处，获取锁，锁住的对象都是 <code>this.singletonObjects</code>，因为在单例模式中必须要<strong>保证全局唯一</strong>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>//DefaultSingletonBeanRegistry.java
</span><span class=c1></span>   
<span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>singletonObjects</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;(</span><span class=n>256</span><span class=o>);</span>
   
<span class=kd>public</span> <span class=kd>final</span> <span class=n>Object</span> <span class=nf>getSingletonMutex</span><span class=o>()</span> <span class=o>{</span>
 <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>singletonObjects</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div></li><li><p><code>&lt;2>处</code>， 缓存为空，则从调用#<code>doGetObjectFromFactoryBean(factory, beanName)</code>方法,[详见2.2](#2.2 <code>doGetObjectFromFactoryBean</code>)。</p></li><li><p><code>&lt;3>处</code>，如果需要后续处理( <code>shouldPostProcess = true</code> )，则进行进一步处理：</p><ul><li>若该 Bean 处于创建中（<code>#isSingletonCurrentlyInCreation(String beanName)</code> 方法返回 <code>true</code> ），则返回<strong>非处理的 Bean 对象</strong>，而不是存储它。[详见2.3](#2.3 <code>isSingletonCurrentlyInCreation</code>)</li><li>调用 <code>#beforeSingletonCreation(String beanName)</code> 方法，进行创建之前的处理。默认实现将该 Bean 标志为当前创建的。</li><li>调用 <code>#postProcessObjectFromFactoryBean(Object object, String beanName)</code> 方法，对从 FactoryBean 获取的 Bean 实例对象进行后置处理。[详见2.4](#2.4 <code>postProcessObjectFromFactoryBean</code>)</li><li>调用 <code>#afterSingletonCreation(String beanName)</code> 方法，进行创建 Bean 之后的处理，默认实现是将该 bean 标记为不再在创建中。</li></ul></li><li><p><code>&lt;4>处</code>加入到 <code>factoryBeanObjectCache</code> 缓存中。</p></li></ol><h3 id=22-dogetobjectfromfactorybean>2.2 <code>doGetObjectFromFactoryBean</code></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>// FactoryBeanRegistrySupport.java
</span><span class=c1></span>
<span class=kd>private</span> <span class=n>Object</span> <span class=nf>doGetObjectFromFactoryBean</span><span class=o>(</span><span class=kd>final</span> <span class=n>FactoryBean</span><span class=o>&lt;?&gt;</span> <span class=n>factory</span><span class=o>,</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>beanName</span><span class=o>)</span>
        <span class=kd>throws</span> <span class=n>BeanCreationException</span> <span class=o>{</span>

    <span class=n>Object</span> <span class=n>object</span><span class=o>;</span>
    <span class=k>try</span> <span class=o>{</span>
        <span class=c1>// 需要权限验证
</span><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>getSecurityManager</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>AccessControlContext</span> <span class=n>acc</span> <span class=o>=</span> <span class=n>getAccessControlContext</span><span class=o>();</span>
            <span class=k>try</span> <span class=o>{</span>
                <span class=n>object</span> <span class=o>=</span> <span class=n>AccessController</span><span class=o>.</span><span class=na>doPrivileged</span><span class=o>((</span><span class=n>PrivilegedExceptionAction</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;)</span> <span class=n>factory</span><span class=o>::</span><span class=n>getObject</span><span class=o>,</span> <span class=n>acc</span><span class=o>);</span>
            <span class=o>}</span>
            <span class=k>catch</span> <span class=o>(</span><span class=n>PrivilegedActionException</span> <span class=n>pae</span><span class=o>)</span> <span class=o>{</span>
                <span class=k>throw</span> <span class=n>pae</span><span class=o>.</span><span class=na>getException</span><span class=o>();</span>
            <span class=o>}</span>
        <span class=o>}</span>
        <span class=k>else</span> <span class=o>{</span>
            <span class=c1>// 从 FactoryBean 中，获得 Bean 对象
</span><span class=c1></span>            <span class=n>object</span> <span class=o>=</span> <span class=n>factory</span><span class=o>.</span><span class=na>getObject</span><span class=o>();</span>
        <span class=o>}</span>
    <span class=o>}</span>
    <span class=k>catch</span> <span class=o>(</span><span class=n>FactoryBeanNotInitializedException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>BeanCurrentlyInCreationException</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=n>ex</span><span class=o>.</span><span class=na>toString</span><span class=o>());</span>
    <span class=o>}</span>
    <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>BeanCreationException</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=s>&#34;FactoryBean threw exception on object creation&#34;</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=k>if</span> <span class=o>(</span><span class=n>object</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>isSingletonCurrentlyInCreation</span><span class=o>(</span><span class=n>beanName</span><span class=o>))</span> <span class=o>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>BeanCurrentlyInCreationException</span><span class=o>(</span>
                    <span class=n>beanName</span><span class=o>,</span> <span class=s>&#34;FactoryBean which is currently in creation returned null from getObject&#34;</span><span class=o>);</span>
        <span class=o>}</span>
        <span class=n>object</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NullBean</span><span class=o>();</span>
    <span class=o>}</span>
    <span class=k>return</span> <span class=n>object</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>上面代码重点就在第18行的<code>factory.getObject()</code>,通过调用 <code>FactoryBean#getObject()</code> 方法，获取 Bean 对象。</p><h3 id=23-issingletoncurrentlyincreation>2.3 <code>isSingletonCurrentlyInCreation</code></h3><p><code>#isSingletonCurrentlyInCreation(String beanName)</code> 方法，是用于检测当前 Bean 是否处于创建之中。代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>// DefaultSingletonBeanRegistry.java
</span><span class=c1></span>
<span class=c1>//正在创建中的单例 Bean 的名字的集合
</span><span class=c1></span><span class=kd>private</span> <span class=kd>final</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>singletonsCurrentlyInCreation</span> <span class=o>=</span>
        <span class=n>Collections</span><span class=o>.</span><span class=na>newSetFromMap</span><span class=o>(</span><span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;(</span><span class=n>16</span><span class=o>));</span>
</code></pre></td></tr></table></div></div><p>对应着两个重要的方法,<code>beforeSingletonCreation</code>和<code>afterSingletonCreation</code></p><ul><li><p>集合的元素,是在 <code>#beforeSingletonCreation(String beanName)</code> 方法中添加的。代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>// DefaultSingletonBeanRegistry.java
</span><span class=c1></span>  
<span class=kd>protected</span> <span class=kt>void</span> <span class=nf>beforeSingletonCreation</span><span class=o>(</span><span class=n>String</span> <span class=n>beanName</span><span class=o>)</span> <span class=o>{</span>
  <span class=k>if</span> <span class=o>(!</span><span class=k>this</span><span class=o>.</span><span class=na>inCreationCheckExclusions</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>beanName</span><span class=o>)</span>
            <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=k>this</span><span class=o>.</span><span class=na>singletonsCurrentlyInCreation</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>beanName</span><span class=o>))</span> <span class=o>{</span> <span class=c1>// 添加
</span><span class=c1></span>      <span class=k>throw</span> <span class=k>new</span> <span class=n>BeanCurrentlyInCreationException</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span> <span class=c1>// 如果添加失败，则抛出 BeanCurrentlyInCreationException 异常。
</span><span class=c1></span>  <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div></li><li><p>对 <code>singletonsCurrentlyInCreation</code> 集合 remove 。代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>// DefaultSingletonBeanRegistry.java
</span><span class=c1></span>  
<span class=kd>protected</span> <span class=kt>void</span> <span class=nf>afterSingletonCreation</span><span class=o>(</span><span class=n>String</span> <span class=n>beanName</span><span class=o>)</span> <span class=o>{</span>
  <span class=k>if</span> <span class=o>(!</span><span class=k>this</span><span class=o>.</span><span class=na>inCreationCheckExclusions</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>beanName</span><span class=o>)</span> <span class=o>&amp;&amp;</span>
            <span class=o>!</span><span class=k>this</span><span class=o>.</span><span class=na>singletonsCurrentlyInCreation</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>beanName</span><span class=o>))</span> <span class=o>{</span> <span class=c1>// 移除
</span><span class=c1></span>      <span class=c1>// 如果移除失败，则抛出 IllegalStateException 异常
</span><span class=c1></span>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Singleton &#39;&#34;</span> <span class=o>+</span> <span class=n>beanName</span> <span class=o>+</span> <span class=s>&#34;&#39; isn&#39;t currently in creation&#34;</span><span class=o>);</span>
  <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div></li></ul><h3 id=24-postprocessobjectfromfactorybean>2.4 <code>postProcessObjectFromFactoryBean</code></h3><p><code>postProcessObjectFromFactoryBean(Object object, String beanName)</code> 方法，对从 FactoryBean 处获取的 Bean 实例对象进行后置处理。其默认实现是直接返回 object 对象，不做任何处理。代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>// DefaultSingletonBeanRegistry.java
</span><span class=c1></span>
<span class=kd>protected</span> <span class=n>Object</span> <span class=nf>postProcessObjectFromFactoryBean</span><span class=o>(</span><span class=n>Object</span> <span class=n>object</span><span class=o>,</span> <span class=n>String</span> <span class=n>beanName</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>BeansException</span> <span class=o>{</span>
	<span class=k>return</span> <span class=n>object</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>Spring中获取bean的规则有这样一条：尽可能保证所有 bean 初始化后都会调用注册的 <code>BeanPostProcessor#postProcessAfterInitialization(Object bean, String beanName)</code> 方法进行处理，在实际开发过程中可以针对此特性设计自己的业务逻辑。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>本文于 2020-04-18 更新</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/ioc-get-bean-getsingleton/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://cool-sen.github.io/posts/ioc-get-bean-getsingleton/ data-title="Spring-IOC-从单例缓存中获取单例 Bean"><i class="fab fa-weibo fa-fw"></i></a><a href=javascript:void(0); title="分享到 百度" data-sharer=baidu data-url=https://cool-sen.github.io/posts/ioc-get-bean-getsingleton/ data-title="Spring-IOC-从单例缓存中获取单例 Bean"><i class="loveit it-baidu-fill"></i></a><a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://cool-sen.github.io/posts/ioc-get-bean-getsingleton/ data-title="Spring-IOC-从单例缓存中获取单例 Bean"><i class="fab fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/spring>Spring</a>,&nbsp;<a href=/tags/ioc>IOC</a></section><section><span><a href=javascript:window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/ioc-get-bean-1/ class=prev rel=prev title="﻿IoC -加载 Bean-总览"><i class="fas fa-angle-left fa-fw"></i>﻿IoC -加载 Bean-总览</a>
<a href=/posts/template/ class=next rel=next title="IOC XMLBeanDefinitionReader">IOC XMLBeanDefinitionReader<i class="fas fa-angle-right fa-fw"></i></a></div></div><div class=comment><div id=valine></div><script>document.addEventListener("DOMContentLoaded",function(event){new Valine({el:'#valine',appId:'EVeKQGJoyzwUXAUhbwnrWRef-gzGzoHsz',appKey:'YMah0NIRauENVCUV8o5vhPMN',placeholder:'说点什么吧...',verify:true,avatar:'mm',pageSize:10,lang:'en',visitor:true,recordIP:true,});});</script><noscript>Please enable JavaScript to view the <a href=https://valine.js.org/>comments powered by Valine.</a></noscript></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line>由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer"><i class="far fa-heart fa-fw"></i>LoveIt</a></div><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>shuaisenma</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><a href=# class="dynamic-to-top animated faster" id=dynamic-to-top><i class="fas fa-chevron-up fa-fw"></i></a><script>document.addEventListener('DOMContentLoaded',function(){lightGallery(document.getElementById('content'),{selector:'.lightgallery',speed:400,hideBarsDelay:2000,thumbnail:true,exThumbImage:'data-thumbnail',thumbWidth:80,thumbContHeight:80,});});</script><link rel=stylesheet href=/lib/valine/valine.css><link rel=stylesheet href=/lib/iconfont/iconfont.min.css><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><script src=https://cdn.staticfile.org/valine/1.3.10/Valine.min.js></script><script src=https://cdn.staticfile.org/smooth-scroll/16.1.0/smooth-scroll.polyfills.min.js></script><script src=https://cdn.staticfile.org/lazysizes/5.2.0/lazysizes.min.js></script><script src=/lib/sharer/sharer.min.js></script><script src=/lib/lightgallery/lightgallery.min.js></script><script src=/lib/lightgallery/lg-thumbnail.min.js></script><script src=/lib/lightgallery/lg-zoom.min.js></script><script src=/js/theme.min.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-105751499-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>