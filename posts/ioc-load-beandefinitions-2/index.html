<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Spring-IOC-默认标签的解析 | Recording</title><meta name=Description content="recording my life"><meta property="og:title" content="Spring-IOC-默认标签的解析"><meta property="og:description" content="前言 Spring中的标签包括默认标签和自定义标签两种，而两种标签的用法以及解析方式存在着很大的不同。本篇文章主要分析默认标签的解析。 默认标签"><meta property="og:type" content="article"><meta property="og:url" content="https://cool-sen.github.io/posts/ioc-load-beandefinitions-2/"><meta property="article:published_time" content="2020-04-19T15:57:17+08:00"><meta property="article:modified_time" content="2020-04-19T15:57:17+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Spring-IOC-默认标签的解析"><meta name=twitter:description content="前言 Spring中的标签包括默认标签和自定义标签两种，而两种标签的用法以及解析方式存在着很大的不同。本篇文章主要分析默认标签的解析。 默认标签"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=canonical href=https://cool-sen.github.io/posts/ioc-load-beandefinitions-2/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=prev href=https://cool-sen.github.io/posts/bak/template/><link rel=next href=https://cool-sen.github.io/posts/ioc-get-bean-1/><link href=https://cdn.staticfile.org/font-awesome/5.12.1/css/all.min.css rel=stylesheet><link href=https://cdn.staticfile.org/animate.css/3.7.2/animate.css rel=stylesheet><link rel=stylesheet href=/css/style.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Spring-IOC-默认标签的解析","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/cool-sen.github.io\/posts\/ioc-load-beandefinitions-2\/"},"image":{"@type":"ImageObject","url":"https:\/\/cool-sen.github.io\/","width":800,"height":600},"genre":"posts","keywords":"Spring, IOC","wordcount":6013,"url":"https:\/\/cool-sen.github.io\/posts\/ioc-load-beandefinitions-2\/","datePublished":"2020-04-19","dateModified":"2020-04-19","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"ZhaoQiang","logo":{"@type":"ImageObject","url":"https:\/\/cool-sen.github.io\/","width":127,"height":40}},"author":{"@type":"Person","name":"shuaisenma"},"description":""}</script></head><body><script>if(!window.localStorage||!window.localStorage.getItem('theme')){window.isDark=window.matchMedia('(prefers-color-scheme: dark)').matches;}else{window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';}
window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/>Recording</a></div><div class=menu><a class=menu-item href=/posts rel="noopener noreffer">文章</a><a class=menu-item href=/tags rel="noopener noreffer">标签</a><a class=menu-item href=/categories rel="noopener noreffer">分类</a><a class=menu-item href=/about rel="noopener noreffer">关于</a><span class=menu-item>|</span>
<a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></header><header class=mobile id=header-mobile><div class=header-wrapper><div class=header-container><div class=header-title><a href=/>Recording</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts rel="noopener noreffer">文章</a><a class=menu-item href=/tags rel="noopener noreffer">标签</a><a class=menu-item href=/categories rel="noopener noreffer">分类</a><a class=menu-item href=/about rel="noopener noreffer">关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><script>window.desktopHeaderMode="fixed";window.mobileHeaderMode="auto";</script><main class=main><div class=container><article class="page single"><h1 class="single-title animated flipInX">Spring-IOC-默认标签的解析</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>shuaisenma</a>
</span>&nbsp;
<span class=post-category>收录于<a href=/categories/spring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90>
<i class="far fa-folder fa-fw"></i>Spring源码分析</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-04-19>2020-04-19</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>约 6013 字&nbsp;
<i class="far fa-clock fa-fw"></i>预计阅读 13 分钟&nbsp;<span id=/posts/ioc-load-beandefinitions-2/ class=leancloud_visitors data-flag-title=Spring-IOC-默认标签的解析>
<i class="far fa-eye fa-fw"></i><span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div></div><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto></div></div><div class=toc id=toc-static><details><summary><div class=toc-title><span>目录</span>
<span><i class="details icon fas fa-angle-down"></i></span></div></summary><div class=toc-content id=toc-content-static><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#1-总体流程>1 总体流程</a></li><li><a href=#2-parsebeandefinitionelement方法分析>2 <code>parseBeanDefinitionElement</code>方法分析</a><ul><li><a href=#21-parsebeandefinitionelement分析>2.1 <code>parseBeanDefinitionElement</code>分析</a><ul><li><a href=#211-创建abstractbeandefinition-对象>2.1.1 创建<code>AbstractBeanDefinition </code>对象</a></li><li><a href=#212-parsebeandefinitionattributes>2.1.2 <code>parseBeanDefinitionAttributes</code></a></li><li><a href=#213-解析-beanbean-内部的子元素>2.1.3 解析 <code>&lt;bean>...&lt;/bean> </code>内部的子元素</a></li></ul></li></ul></li><li><a href=#3-decoratebeandefinitionifrequired方法分析>3 <code>decorateBeanDefinitionIfRequired</code>方法分析</a></li><li><a href=#4-registerbeandefinition方法分析>4 <code>registerBeanDefinition</code>方法分析</a><ul><li><a href=#41-通过beanname注册>4.1 通过<code>beanName</code>注册</a></li><li><a href=#42-通过别名注册>4.2 通过别名注册</a></li></ul></li><li><a href=#5-通知监听器解析及注册完成>5 　通知监听器解析及注册完成</a></li><li><a href=#参考>参考</a></li></ul></nav></div></details></div><div class=content id=content><h2 id=前言>前言</h2><p>Spring中的标签包括默认标签和自定义标签两种，而两种标签的用法以及解析方式存在着很大的不同。本篇文章主要分析默认标签的解析。</p><p>默认标签的解析是在<code>parseDefaultElement</code>方法中进行。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>// DefaultBeanDefinitionDocumentReader.java
</span><span class=c1></span>
<span class=kd>private</span> <span class=kt>void</span> <span class=nf>parseDefaultElement</span><span class=o>(</span><span class=n>Element</span> <span class=n>ele</span><span class=o>,</span> <span class=n>BeanDefinitionParserDelegate</span> <span class=n>delegate</span><span class=o>)</span> <span class=o>{</span>
		<span class=c1>//对import标签的处理
</span><span class=c1></span>		<span class=k>if</span> <span class=o>(</span><span class=n>delegate</span><span class=o>.</span><span class=na>nodeNameEquals</span><span class=o>(</span><span class=n>ele</span><span class=o>,</span> <span class=n>IMPORT_ELEMENT</span><span class=o>))</span> <span class=o>{</span>
			<span class=n>importBeanDefinitionResource</span><span class=o>(</span><span class=n>ele</span><span class=o>);</span>
		<span class=o>}</span>
		<span class=c1>//对alias标签的处理
</span><span class=c1></span>		<span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>delegate</span><span class=o>.</span><span class=na>nodeNameEquals</span><span class=o>(</span><span class=n>ele</span><span class=o>,</span> <span class=n>ALIAS_ELEMENT</span><span class=o>))</span> <span class=o>{</span>
			<span class=n>processAliasRegistration</span><span class=o>(</span><span class=n>ele</span><span class=o>);</span>
		<span class=o>}</span>
		<span class=c1>//对bean标签的处理
</span><span class=c1></span>		<span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>delegate</span><span class=o>.</span><span class=na>nodeNameEquals</span><span class=o>(</span><span class=n>ele</span><span class=o>,</span> <span class=n>BEAN_ELEMENT</span><span class=o>))</span> <span class=o>{</span>
			<span class=n>processBeanDefinition</span><span class=o>(</span><span class=n>ele</span><span class=o>,</span> <span class=n>delegate</span><span class=o>);</span>
		<span class=o>}</span>
		<span class=c1>//对beans标签的处理
</span><span class=c1></span>		<span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>delegate</span><span class=o>.</span><span class=na>nodeNameEquals</span><span class=o>(</span><span class=n>ele</span><span class=o>,</span> <span class=n>NESTED_BEANS_ELEMENT</span><span class=o>))</span> <span class=o>{</span>
			<span class=c1>// recurse
</span><span class=c1></span>			<span class=n>doRegisterBeanDefinitions</span><span class=o>(</span><span class=n>ele</span><span class=o>);</span>
		<span class=o>}</span>
	<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>在以上四种标签的解析中，对bean标签的解析是最复杂的，也是最重要的。本篇文章就重点对bean标签的解析做一些分析。</p><h2 id=1-总体流程>1 总体流程</h2><p><code>processBeanDefinition</code>方法功能就是对bean标签就行解析，源码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>// DefaultBeanDefinitionDocumentReader.java
</span><span class=c1></span>
<span class=kd>protected</span> <span class=kt>void</span> <span class=nf>processBeanDefinition</span><span class=o>(</span><span class=n>Element</span> <span class=n>ele</span><span class=o>,</span> <span class=n>BeanDefinitionParserDelegate</span> <span class=n>delegate</span><span class=o>)</span> <span class=o>{</span>
		<span class=c1>// 1. 如果解析成功，则返回 BeanDefinitionHolder 对象。如果解析失败，则返回 null 。
</span><span class=c1></span>		<span class=n>BeanDefinitionHolder</span> <span class=n>bdHolder</span> <span class=o>=</span> <span class=n>delegate</span><span class=o>.</span><span class=na>parseBeanDefinitionElement</span><span class=o>(</span><span class=n>ele</span><span class=o>);</span>
		<span class=k>if</span> <span class=o>(</span><span class=n>bdHolder</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
			<span class=c1>// 2. 进行自定义标签处理
</span><span class=c1></span>			<span class=n>bdHolder</span> <span class=o>=</span> <span class=n>delegate</span><span class=o>.</span><span class=na>decorateBeanDefinitionIfRequired</span><span class=o>(</span><span class=n>ele</span><span class=o>,</span> <span class=n>bdHolder</span><span class=o>);</span>
			<span class=k>try</span> <span class=o>{</span>
				<span class=c1>// 3. 进行 BeanDefinition 的注册
</span><span class=c1></span>				<span class=c1>// Register the final decorated instance.
</span><span class=c1></span>				<span class=n>BeanDefinitionReaderUtils</span><span class=o>.</span><span class=na>registerBeanDefinition</span><span class=o>(</span><span class=n>bdHolder</span><span class=o>,</span> <span class=n>getReaderContext</span><span class=o>().</span><span class=na>getRegistry</span><span class=o>());</span>
			<span class=o>}</span>
			<span class=k>catch</span> <span class=o>(</span><span class=n>BeanDefinitionStoreException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
				<span class=n>getReaderContext</span><span class=o>().</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;Failed to register bean definition with name &#39;&#34;</span> <span class=o>+</span>
						<span class=n>bdHolder</span><span class=o>.</span><span class=na>getBeanName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;&#39;&#34;</span><span class=o>,</span> <span class=n>ele</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
			<span class=o>}</span>
			<span class=c1>// 4. 发出响应事件，通知相关的监听器，这个bean已经解析完成了。
</span><span class=c1></span>			<span class=c1>// Send registration event.
</span><span class=c1></span>			<span class=n>getReaderContext</span><span class=o>().</span><span class=na>fireComponentRegistered</span><span class=o>(</span><span class=k>new</span> <span class=n>BeanComponentDefinition</span><span class=o>(</span><span class=n>bdHolder</span><span class=o>));</span>
		<span class=o>}</span>
	<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>上面方法的主要步骤为：</p><ol><li>调用 <code>BeanDefinitionParserDelegate</code>类的<code>parseBeanDefinitionElement(Element ele, BeanDefinitionParserDelegate delegate)</code> 方法，进行元素解析。</li></ol><ul><li>如果解析<strong>失败</strong>，则返回 <code>null</code>，错误由<code>ProblemReporter</code>处理。</li><li>如果解析<strong>成功</strong>，则返回 <code>BeanDefinitionHolder</code> 实例 <code>bdHolder</code> 。<code>bdHolder</code>实例已经包含配置文件中配置的各种属性了，例如class、name、id、alias之类的属性。</li></ul><ol start=2><li>若实例 <code>bdHolder</code> 不为空,则调用 <code>BeanDefinitionParserDelegate</code>类的<code>decorateBeanDefinitionIfRequired(Element ele, BeanDefinitionHolder bdHolder)</code> 方法，进行自定义标签处理。</li><li>对解析后的<code>bdHolder</code>进行注册,通过调用 <code>BeanDefinitionReaderUtils</code>类的<code>registerBeanDefinition(BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)</code> 方法。</li><li>最后发出响应事件，通知相关的监听器，这个bean已经加载完成了。</li></ol><p>下面就重点对上面四个步骤做个详细介绍。</p><h2 id=2-parsebeandefinitionelement方法分析>2 <code>parseBeanDefinitionElement</code>方法分析</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>//BeanDefinitionParserDelegate.java
</span><span class=c1></span>
<span class=nd>@Nullable</span>
<span class=kd>public</span> <span class=n>BeanDefinitionHolder</span> <span class=nf>parseBeanDefinitionElement</span><span class=o>(</span><span class=n>Element</span> <span class=n>ele</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>BeanDefinition</span> <span class=n>containingBean</span><span class=o>)</span> <span class=o>{</span>
		<span class=c1>// 1. 解析 id 和 name 属性
</span><span class=c1></span>		<span class=n>String</span> <span class=n>id</span> <span class=o>=</span> <span class=n>ele</span><span class=o>.</span><span class=na>getAttribute</span><span class=o>(</span><span class=n>ID_ATTRIBUTE</span><span class=o>);</span>
		<span class=n>String</span> <span class=n>nameAttr</span> <span class=o>=</span> <span class=n>ele</span><span class=o>.</span><span class=na>getAttribute</span><span class=o>(</span><span class=n>NAME_ATTRIBUTE</span><span class=o>);</span>
		<span class=c1>// 计算别名集合
</span><span class=c1></span>		<span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>aliases</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
		<span class=k>if</span> <span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>hasLength</span><span class=o>(</span><span class=n>nameAttr</span><span class=o>))</span> <span class=o>{</span>
			<span class=n>String</span><span class=o>[]</span> <span class=n>nameArr</span> <span class=o>=</span> <span class=n>StringUtils</span><span class=o>.</span><span class=na>tokenizeToStringArray</span><span class=o>(</span><span class=n>nameAttr</span><span class=o>,</span> <span class=n>MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span class=o>);</span>
			<span class=n>aliases</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>Arrays</span><span class=o>.</span><span class=na>asList</span><span class=o>(</span><span class=n>nameArr</span><span class=o>));</span>
		<span class=o>}</span>
		<span class=c1>// 3.1 beanName ，优先使用 id
</span><span class=c1></span>		<span class=n>String</span> <span class=n>beanName</span> <span class=o>=</span> <span class=n>id</span><span class=o>;</span>
		<span class=k>if</span> <span class=o>(!</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>hasText</span><span class=o>(</span><span class=n>beanName</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>aliases</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
			<span class=c1>// 3.2 beanName ，其次使用 aliases 的第一个
</span><span class=c1></span>			<span class=n>beanName</span> <span class=o>=</span> <span class=n>aliases</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
			<span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isTraceEnabled</span><span class=o>())</span> <span class=o>{</span>
				<span class=n>logger</span><span class=o>.</span><span class=na>trace</span><span class=o>(</span><span class=s>&#34;No XML &#39;id&#39; specified - using &#39;&#34;</span> <span class=o>+</span> <span class=n>beanName</span> <span class=o>+</span>
						<span class=s>&#34;&#39; as bean name and &#34;</span> <span class=o>+</span> <span class=n>aliases</span> <span class=o>+</span> <span class=s>&#34; as aliases&#34;</span><span class=o>);</span>
			<span class=o>}</span>
		<span class=o>}</span>
		<span class=c1>// 检查 beanName 的唯一性
</span><span class=c1></span>		<span class=k>if</span> <span class=o>(</span><span class=n>containingBean</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
			<span class=n>checkNameUniqueness</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=n>aliases</span><span class=o>,</span> <span class=n>ele</span><span class=o>);</span>
		<span class=o>}</span>
		<span class=c1>// 2. 解析属性，构造 AbstractBeanDefinition 对象
</span><span class=c1></span>		<span class=n>AbstractBeanDefinition</span> <span class=n>beanDefinition</span> <span class=o>=</span> <span class=n>parseBeanDefinitionElement</span><span class=o>(</span><span class=n>ele</span><span class=o>,</span> <span class=n>beanName</span><span class=o>,</span> <span class=n>containingBean</span><span class=o>);</span>
		<span class=k>if</span> <span class=o>(</span><span class=n>beanDefinition</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
			<span class=c1>// 3.beanName，最后使用 beanName 生成规则
</span><span class=c1></span>			<span class=k>if</span> <span class=o>(!</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>hasText</span><span class=o>(</span><span class=n>beanName</span><span class=o>))</span> <span class=o>{</span>
				<span class=k>try</span> <span class=o>{</span>
					<span class=k>if</span> <span class=o>(</span><span class=n>containingBean</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
						<span class=c1>// 3. 使用 beanName 生成规则，生成唯一的 beanName
</span><span class=c1></span>						<span class=n>beanName</span> <span class=o>=</span> <span class=n>BeanDefinitionReaderUtils</span><span class=o>.</span><span class=na>generateBeanName</span><span class=o>(</span>
								<span class=n>beanDefinition</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>readerContext</span><span class=o>.</span><span class=na>getRegistry</span><span class=o>(),</span> <span class=kc>true</span><span class=o>);</span>
					<span class=o>}</span>
					<span class=k>else</span> <span class=o>{</span>
						<span class=n>beanName</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>readerContext</span><span class=o>.</span><span class=na>generateBeanName</span><span class=o>(</span><span class=n>beanDefinition</span><span class=o>);</span>
						<span class=c1>// Register an alias for the plain bean class name, if still possible,
</span><span class=c1></span>						<span class=c1>// if the generator returned the class name plus a suffix.
</span><span class=c1></span>						<span class=c1>// This is expected for Spring 1.2/2.0 backwards compatibility.
</span><span class=c1></span>						<span class=c1>//3. 使用 beanName 生成规则，生成唯一的 beanName
</span><span class=c1></span>						<span class=n>String</span> <span class=n>beanClassName</span> <span class=o>=</span> <span class=n>beanDefinition</span><span class=o>.</span><span class=na>getBeanClassName</span><span class=o>();</span>
						<span class=k>if</span> <span class=o>(</span><span class=n>beanClassName</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span>
								<span class=n>beanName</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=n>beanClassName</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=n>beanName</span><span class=o>.</span><span class=na>length</span><span class=o>()</span> <span class=o>&gt;</span> <span class=n>beanClassName</span><span class=o>.</span><span class=na>length</span><span class=o>()</span> <span class=o>&amp;&amp;</span>
								<span class=o>!</span><span class=k>this</span><span class=o>.</span><span class=na>readerContext</span><span class=o>.</span><span class=na>getRegistry</span><span class=o>().</span><span class=na>isBeanNameInUse</span><span class=o>(</span><span class=n>beanClassName</span><span class=o>))</span> <span class=o>{</span>
							<span class=n>aliases</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>beanClassName</span><span class=o>);</span>
						<span class=o>}</span>
					<span class=o>}</span>
					<span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isTraceEnabled</span><span class=o>())</span> <span class=o>{</span>
						<span class=n>logger</span><span class=o>.</span><span class=na>trace</span><span class=o>(</span><span class=s>&#34;Neither XML &#39;id&#39; nor &#39;name&#39; specified - &#34;</span> <span class=o>+</span>
								<span class=s>&#34;using generated bean name [&#34;</span> <span class=o>+</span> <span class=n>beanName</span> <span class=o>+</span> <span class=s>&#34;]&#34;</span><span class=o>);</span>
					<span class=o>}</span>
				<span class=o>}</span>
				<span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
					<span class=n>error</span><span class=o>(</span><span class=n>ex</span><span class=o>.</span><span class=na>getMessage</span><span class=o>(),</span> <span class=n>ele</span><span class=o>);</span>
					<span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
				<span class=o>}</span>
			<span class=o>}</span>
			<span class=n>String</span><span class=o>[]</span> <span class=n>aliasesArray</span> <span class=o>=</span> <span class=n>StringUtils</span><span class=o>.</span><span class=na>toStringArray</span><span class=o>(</span><span class=n>aliases</span><span class=o>);</span>
			<span class=c1>// 4. 创建 BeanDefinitionHolder 对象
</span><span class=c1></span>			<span class=k>return</span> <span class=k>new</span> <span class=n>BeanDefinitionHolder</span><span class=o>(</span><span class=n>beanDefinition</span><span class=o>,</span> <span class=n>beanName</span><span class=o>,</span> <span class=n>aliasesArray</span><span class=o>);</span>
		<span class=o>}</span>

		<span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
	<span class=o>}</span>	
</code></pre></td></tr></table></div></div><p>上面方法主要分为四个步骤：</p><ol><li><p>提取元素中的id以及name属性。</p></li><li><p>调用<code>parseBeanDefinitionElement(ele, beanName, containingBean)</code>方法对属性进行解析并封装成 <code>AbstractBeanDefinition</code> 实例 <code>beanDefinition</code> 。</p></li><li><p>生成唯一的<code>beanName</code>,<code>beanName</code> 的命名规则为：</p><ul><li>3.1 处 ，如果 <code>id</code> 不为空，则 <code>beanName = id</code> 。</li><li>3.2 处，如果 <code>id</code> 为空，但是 <code>aliases</code> 不空，则 <code>beanName</code> 为 <code>aliases</code> 的<strong>第一个</strong>元素。</li><li>3.3 处，如果两者都为空，则根据<strong>默认规则</strong>来设置 <code>beanName </code>。</li></ul></li><li><p>根据所获取的信息（<code>beanName</code>、<code>aliases</code>、<code>beanDefinition</code>）构造 <code>BeanDefinitionHolder</code> 实例对象并返回。</p></li></ol><h3 id=21-parsebeandefinitionelement分析>2.1 <code>parseBeanDefinitionElement</code>分析</h3><p><strong>注意</strong>，这个<code>parseBeanDefinitionElement</code>与上一节的<code>parseBeanDefinitionElement</code>不同，这一小节的<code>parseBeanDefinitionElement</code>方法多了一个参数<code>beanName</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>//BeanDefinitionParserDelegate.java
</span><span class=c1></span>
<span class=nd>@Nullable</span>
<span class=kd>public</span> <span class=n>AbstractBeanDefinition</span> <span class=nf>parseBeanDefinitionElement</span><span class=o>(</span>
			<span class=n>Element</span> <span class=n>ele</span><span class=o>,</span> <span class=n>String</span> <span class=n>beanName</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>BeanDefinition</span> <span class=n>containingBean</span><span class=o>)</span> <span class=o>{</span>

		<span class=k>this</span><span class=o>.</span><span class=na>parseState</span><span class=o>.</span><span class=na>push</span><span class=o>(</span><span class=k>new</span> <span class=n>BeanEntry</span><span class=o>(</span><span class=n>beanName</span><span class=o>));</span>

		<span class=n>String</span> <span class=n>className</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
		<span class=c1>// 解析 class 属性
</span><span class=c1></span>		<span class=k>if</span> <span class=o>(</span><span class=n>ele</span><span class=o>.</span><span class=na>hasAttribute</span><span class=o>(</span><span class=n>CLASS_ATTRIBUTE</span><span class=o>))</span> <span class=o>{</span>
			<span class=n>className</span> <span class=o>=</span> <span class=n>ele</span><span class=o>.</span><span class=na>getAttribute</span><span class=o>(</span><span class=n>CLASS_ATTRIBUTE</span><span class=o>).</span><span class=na>trim</span><span class=o>();</span>
		<span class=o>}</span>
		<span class=n>String</span> <span class=n>parent</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
		<span class=c1>// 解析 parent 属性
</span><span class=c1></span>		<span class=k>if</span> <span class=o>(</span><span class=n>ele</span><span class=o>.</span><span class=na>hasAttribute</span><span class=o>(</span><span class=n>PARENT_ATTRIBUTE</span><span class=o>))</span> <span class=o>{</span>
			<span class=n>parent</span> <span class=o>=</span> <span class=n>ele</span><span class=o>.</span><span class=na>getAttribute</span><span class=o>(</span><span class=n>PARENT_ATTRIBUTE</span><span class=o>);</span>
		<span class=o>}</span>

		<span class=k>try</span> <span class=o>{</span>
			<span class=c1>// 创建用于承载属性的 AbstractBeanDefinition 实例
</span><span class=c1></span>			<span class=n>AbstractBeanDefinition</span> <span class=n>bd</span> <span class=o>=</span> <span class=n>createBeanDefinition</span><span class=o>(</span><span class=n>className</span><span class=o>,</span> <span class=n>parent</span><span class=o>);</span>

			<span class=c1>// 解析默认 bean 的各种属性
</span><span class=c1></span>			<span class=n>parseBeanDefinitionAttributes</span><span class=o>(</span><span class=n>ele</span><span class=o>,</span> <span class=n>beanName</span><span class=o>,</span> <span class=n>containingBean</span><span class=o>,</span> <span class=n>bd</span><span class=o>);</span>
			<span class=c1>// 提取 description
</span><span class=c1></span>			<span class=n>bd</span><span class=o>.</span><span class=na>setDescription</span><span class=o>(</span><span class=n>DomUtils</span><span class=o>.</span><span class=na>getChildElementValueByTagName</span><span class=o>(</span><span class=n>ele</span><span class=o>,</span> <span class=n>DESCRIPTION_ELEMENT</span><span class=o>));</span>

			<span class=c1>// 下面的一堆是解析 &lt;bean&gt;......&lt;/bean&gt; 内部的子元素
</span><span class=c1></span>			<span class=c1>// 解析出来以后的信息都放到 bd 的属性中
</span><span class=c1></span>
			<span class=c1>// 解析元数据 &lt;meta /&gt;
</span><span class=c1></span>			<span class=n>parseMetaElements</span><span class=o>(</span><span class=n>ele</span><span class=o>,</span> <span class=n>bd</span><span class=o>);</span>
			<span class=c1>// 解析 lookup-method 属性 &lt;lookup-method /&gt;
</span><span class=c1></span>			<span class=n>parseLookupOverrideSubElements</span><span class=o>(</span><span class=n>ele</span><span class=o>,</span> <span class=n>bd</span><span class=o>.</span><span class=na>getMethodOverrides</span><span class=o>());</span>
			<span class=c1>// 解析 replaced-method 属性 &lt;replaced-method /&gt;
</span><span class=c1></span>			<span class=n>parseReplacedMethodSubElements</span><span class=o>(</span><span class=n>ele</span><span class=o>,</span> <span class=n>bd</span><span class=o>.</span><span class=na>getMethodOverrides</span><span class=o>());</span>

			<span class=c1>// 解析构造函数参数 &lt;constructor-arg /&gt;
</span><span class=c1></span>			<span class=n>parseConstructorArgElements</span><span class=o>(</span><span class=n>ele</span><span class=o>,</span> <span class=n>bd</span><span class=o>);</span>
			<span class=c1>// 解析 property 子元素 &lt;property /&gt;
</span><span class=c1></span>			<span class=n>parsePropertyElements</span><span class=o>(</span><span class=n>ele</span><span class=o>,</span> <span class=n>bd</span><span class=o>);</span>
			<span class=c1>// 解析 qualifier 子元素 &lt;qualifier /&gt;
</span><span class=c1></span>			<span class=n>parseQualifierElements</span><span class=o>(</span><span class=n>ele</span><span class=o>,</span> <span class=n>bd</span><span class=o>);</span>

			<span class=n>bd</span><span class=o>.</span><span class=na>setResource</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>readerContext</span><span class=o>.</span><span class=na>getResource</span><span class=o>());</span>
			<span class=n>bd</span><span class=o>.</span><span class=na>setSource</span><span class=o>(</span><span class=n>extractSource</span><span class=o>(</span><span class=n>ele</span><span class=o>));</span>

			<span class=k>return</span> <span class=n>bd</span><span class=o>;</span>
		<span class=o>}</span>
		<span class=k>catch</span> <span class=o>(</span><span class=n>ClassNotFoundException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
			<span class=n>error</span><span class=o>(</span><span class=s>&#34;Bean class [&#34;</span> <span class=o>+</span> <span class=n>className</span> <span class=o>+</span> <span class=s>&#34;] not found&#34;</span><span class=o>,</span> <span class=n>ele</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
		<span class=o>}</span>
		<span class=k>catch</span> <span class=o>(</span><span class=n>NoClassDefFoundError</span> <span class=n>err</span><span class=o>)</span> <span class=o>{</span>
			<span class=n>error</span><span class=o>(</span><span class=s>&#34;Class that bean class [&#34;</span> <span class=o>+</span> <span class=n>className</span> <span class=o>+</span> <span class=s>&#34;] depends on not found&#34;</span><span class=o>,</span> <span class=n>ele</span><span class=o>,</span> <span class=n>err</span><span class=o>);</span>
		<span class=o>}</span>
		<span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
			<span class=n>error</span><span class=o>(</span><span class=s>&#34;Unexpected failure during bean definition parsing&#34;</span><span class=o>,</span> <span class=n>ele</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
		<span class=o>}</span>
		<span class=k>finally</span> <span class=o>{</span>
			<span class=k>this</span><span class=o>.</span><span class=na>parseState</span><span class=o>.</span><span class=na>pop</span><span class=o>();</span>
		<span class=o>}</span>

		<span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
	<span class=o>}</span>	

</code></pre></td></tr></table></div></div><p>该方法解析了bean标签的所有属性，有常用的，也有不常用的。</p><p>其中有两个重要的方法</p><ul><li><code>createBeanDefinition(className, parent)</code>,该方法作用是创建 <code>AbstractBeanDefinition </code>对象。<code>AbstractBeanDefinition </code>有什么用，为什么要创建<code>AbstractBeanDefinition </code>对象呢？请看下面的补充分析。</li><li><code>parseBeanDefinitionAttributes(ele, beanName, containingBean, bd)</code>,该方法作用是解析默认 bean 的各种属性。</li></ul><h4 id=211-创建abstractbeandefinition-对象>2.1.1 创建<code>AbstractBeanDefinition </code>对象</h4><p>讲创建<code>AbstractBeanDefinition </code>对象之前，先来补充下<code>BeanDefinition</code>的一些知识。</p><p><code>org.springframework.beans.factory.config.BeanDefinition</code> ，是一个接口，它描述了一个 Bean 实例的定义，包括属性值、构造方法值和继承它的类的更多信息。</p><p><img class=lazyload src=/svg/loading.small.min.svg data-sizes=auto data-srcset="/images/IoC-load-BeanDefinitions-2/image-20200419210842067.png,  1.5x,  2x" data-src alt=image-20200419210842067 title=image-20200419210842067></p><center>BeanDefinition相关类图</center><p>从父关系来看，<code>BeanDefinition</code> 继承 <code>AttributeAccessor</code> 和 <code>BeanMetadataElement</code> 接口。</p><ul><li><code>org.springframework.cor.AttributeAccessor</code> 接口，定义了与其它对象的（元数据）进行连接和访问的约定，即对属性的修改，包括获取、设置、删除。</li><li><code>org.springframework.beans.BeanMetadataElement</code> 接口，Bean 元对象持有的配置元素可以通过 <code>getSource()</code> 方法来获取。</li></ul><p>从子关系来看，<code>BeanDefinition</code>在Spring中有三个实现类。<code>ChildBeanDefinition</code>,<code>RootBeanDefinition</code>,<code>GenericBeanDefinition</code>。</p><ul><li><p>三个实现类都继承 <code>AbstractBeanDefinition </code>抽象类</p></li><li><p>如果配置文件中定义了父 <code>&lt;bean></code> 和 子 <code>&lt;bean></code> ，则父<code>&lt;bean></code> 用 <code>RootBeanDefinition</code> 表示，子 <code>&lt;bean></code>用<code> ChildBeanDefinition</code> 表示。没有父 <code>&lt;bean></code> 的就使用<code>RootBeanDefinition </code>表示。</p></li></ul><p>Spring通过<code>BeanDefinition</code>将配置文件中的<bean>配置信息转换为容器的内部表示，并将这些<code>BeanDefiniton</code>注册到<code>BeanDefinitonRegistry</code>中。Spring容器的<code>BeanDefinitionRegistry</code>就像是Spring配置信息的内存数据库，主要是以map的形式保存，后续操作直接从<code>BeanDefinitionRegistry</code>中读取配置信息。</p><p>解析属性首先要创建用于承载属性的实例，也就是创建<code>GenericBeanDefinition</code>类型的实例，<code>createBeanDefinition(className, parent)</code>就是实现这个功能。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>//BeanDefinitionParserDelegate.java
</span><span class=c1></span>
<span class=kd>protected</span> <span class=n>AbstractBeanDefinition</span> <span class=nf>createBeanDefinition</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>String</span> <span class=n>className</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>String</span> <span class=n>parentName</span><span class=o>)</span>
			<span class=kd>throws</span> <span class=n>ClassNotFoundException</span> <span class=o>{</span>

		<span class=k>return</span> <span class=n>BeanDefinitionReaderUtils</span><span class=o>.</span><span class=na>createBeanDefinition</span><span class=o>(</span>
				<span class=n>parentName</span><span class=o>,</span> <span class=n>className</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>readerContext</span><span class=o>.</span><span class=na>getBeanClassLoader</span><span class=o>());</span>
	<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>其中的<code>BeanDefinitionReaderUtils.createBeanDefinition()</code>方法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>// BeanDefinitionReaderUtils.java
</span><span class=c1></span>
<span class=kd>public</span> <span class=kd>static</span> <span class=n>AbstractBeanDefinition</span> <span class=nf>createBeanDefinition</span><span class=o>(</span>
			<span class=nd>@Nullable</span> <span class=n>String</span> <span class=n>parentName</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>String</span> <span class=n>className</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>ClassLoader</span> <span class=n>classLoader</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>ClassNotFoundException</span> <span class=o>{</span>

		<span class=n>GenericBeanDefinition</span> <span class=n>bd</span> <span class=o>=</span> <span class=k>new</span> <span class=n>GenericBeanDefinition</span><span class=o>();</span>
		<span class=n>bd</span><span class=o>.</span><span class=na>setParentName</span><span class=o>(</span><span class=n>parentName</span><span class=o>);</span>
		<span class=k>if</span> <span class=o>(</span><span class=n>className</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
			<span class=k>if</span> <span class=o>(</span><span class=n>classLoader</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
                <span class=c1>// 如果classLoader不为空，使用传入的classLoader同一虚拟机加载类对象
</span><span class=c1></span>				<span class=n>bd</span><span class=o>.</span><span class=na>setBeanClass</span><span class=o>(</span><span class=n>ClassUtils</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=n>className</span><span class=o>,</span> <span class=n>classLoader</span><span class=o>));</span>
			<span class=o>}</span>
			<span class=k>else</span> <span class=o>{</span>
                <span class=c1>// classLoader为空,记录className
</span><span class=c1></span>				<span class=n>bd</span><span class=o>.</span><span class=na>setBeanClassName</span><span class=o>(</span><span class=n>className</span><span class=o>);</span>
			<span class=o>}</span>
		<span class=o>}</span>
		<span class=k>return</span> <span class=n>bd</span><span class=o>;</span>
	<span class=o>}</span>
</code></pre></td></tr></table></div></div><h4 id=212-parsebeandefinitionattributes>2.1.2 <code>parseBeanDefinitionAttributes</code></h4><p><code>arseBeanDefinitionAttributes</code>方法是对element所有元素属性进行解析：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>// BeanDefinitionParserDelegate.java
</span><span class=c1></span>
<span class=kd>public</span> <span class=n>AbstractBeanDefinition</span> <span class=nf>parseBeanDefinitionAttributes</span><span class=o>(</span><span class=n>Element</span> <span class=n>ele</span><span class=o>,</span> <span class=n>String</span> <span class=n>beanName</span><span class=o>,</span>
        <span class=nd>@Nullable</span> <span class=n>BeanDefinition</span> <span class=n>containingBean</span><span class=o>,</span> <span class=n>AbstractBeanDefinition</span> <span class=n>bd</span><span class=o>)</span> <span class=o>{</span>
    <span class=c1>// 解析 scope 属性
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>ele</span><span class=o>.</span><span class=na>hasAttribute</span><span class=o>(</span><span class=n>SINGLETON_ATTRIBUTE</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>error</span><span class=o>(</span><span class=s>&#34;Old 1.x &#39;singleton&#39; attribute in use - upgrade to &#39;scope&#39; declaration&#34;</span><span class=o>,</span> <span class=n>ele</span><span class=o>);</span>
    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>ele</span><span class=o>.</span><span class=na>hasAttribute</span><span class=o>(</span><span class=n>SCOPE_ATTRIBUTE</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>bd</span><span class=o>.</span><span class=na>setScope</span><span class=o>(</span><span class=n>ele</span><span class=o>.</span><span class=na>getAttribute</span><span class=o>(</span><span class=n>SCOPE_ATTRIBUTE</span><span class=o>));</span>
    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>containingBean</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
        <span class=c1>// Take default from containing bean in case of an inner bean definition.
</span><span class=c1></span>        <span class=n>bd</span><span class=o>.</span><span class=na>setScope</span><span class=o>(</span><span class=n>containingBean</span><span class=o>.</span><span class=na>getScope</span><span class=o>());</span>
    <span class=o>}</span>

    <span class=c1>// 解析 abstract 属性
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>ele</span><span class=o>.</span><span class=na>hasAttribute</span><span class=o>(</span><span class=n>ABSTRACT_ATTRIBUTE</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>bd</span><span class=o>.</span><span class=na>setAbstract</span><span class=o>(</span><span class=n>TRUE_VALUE</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>ele</span><span class=o>.</span><span class=na>getAttribute</span><span class=o>(</span><span class=n>ABSTRACT_ATTRIBUTE</span><span class=o>)));</span>
    <span class=o>}</span>

    <span class=c1>// 解析 lazy-init 属性
</span><span class=c1></span>    <span class=n>String</span> <span class=n>lazyInit</span> <span class=o>=</span> <span class=n>ele</span><span class=o>.</span><span class=na>getAttribute</span><span class=o>(</span><span class=n>LAZY_INIT_ATTRIBUTE</span><span class=o>);</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>DEFAULT_VALUE</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>lazyInit</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>lazyInit</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>defaults</span><span class=o>.</span><span class=na>getLazyInit</span><span class=o>();</span>
    <span class=o>}</span>
    <span class=n>bd</span><span class=o>.</span><span class=na>setLazyInit</span><span class=o>(</span><span class=n>TRUE_VALUE</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>lazyInit</span><span class=o>));</span>

    <span class=c1>// 解析 autowire 属性
</span><span class=c1></span>    <span class=n>String</span> <span class=n>autowire</span> <span class=o>=</span> <span class=n>ele</span><span class=o>.</span><span class=na>getAttribute</span><span class=o>(</span><span class=n>AUTOWIRE_ATTRIBUTE</span><span class=o>);</span>
    <span class=n>bd</span><span class=o>.</span><span class=na>setAutowireMode</span><span class=o>(</span><span class=n>getAutowireMode</span><span class=o>(</span><span class=n>autowire</span><span class=o>));</span>

    <span class=c1>// 解析 depends-on 属性
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>ele</span><span class=o>.</span><span class=na>hasAttribute</span><span class=o>(</span><span class=n>DEPENDS_ON_ATTRIBUTE</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>String</span> <span class=n>dependsOn</span> <span class=o>=</span> <span class=n>ele</span><span class=o>.</span><span class=na>getAttribute</span><span class=o>(</span><span class=n>DEPENDS_ON_ATTRIBUTE</span><span class=o>);</span>
        <span class=n>bd</span><span class=o>.</span><span class=na>setDependsOn</span><span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>tokenizeToStringArray</span><span class=o>(</span><span class=n>dependsOn</span><span class=o>,</span> <span class=n>MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span class=o>));</span>
    <span class=o>}</span>

    <span class=c1>// 解析 autowire-candidate 属性
</span><span class=c1></span>    <span class=n>String</span> <span class=n>autowireCandidate</span> <span class=o>=</span> <span class=n>ele</span><span class=o>.</span><span class=na>getAttribute</span><span class=o>(</span><span class=n>AUTOWIRE_CANDIDATE_ATTRIBUTE</span><span class=o>);</span>
    <span class=k>if</span> <span class=o>(</span><span class=s>&#34;&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>autowireCandidate</span><span class=o>)</span> <span class=o>||</span> <span class=n>DEFAULT_VALUE</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>autowireCandidate</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>String</span> <span class=n>candidatePattern</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>defaults</span><span class=o>.</span><span class=na>getAutowireCandidates</span><span class=o>();</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>candidatePattern</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>String</span><span class=o>[]</span> <span class=n>patterns</span> <span class=o>=</span> <span class=n>StringUtils</span><span class=o>.</span><span class=na>commaDelimitedListToStringArray</span><span class=o>(</span><span class=n>candidatePattern</span><span class=o>);</span>
            <span class=n>bd</span><span class=o>.</span><span class=na>setAutowireCandidate</span><span class=o>(</span><span class=n>PatternMatchUtils</span><span class=o>.</span><span class=na>simpleMatch</span><span class=o>(</span><span class=n>patterns</span><span class=o>,</span> <span class=n>beanName</span><span class=o>));</span>
        <span class=o>}</span>
    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
        <span class=n>bd</span><span class=o>.</span><span class=na>setAutowireCandidate</span><span class=o>(</span><span class=n>TRUE_VALUE</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>autowireCandidate</span><span class=o>));</span>
    <span class=o>}</span>

    <span class=c1>// 解析 primary 标签
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>ele</span><span class=o>.</span><span class=na>hasAttribute</span><span class=o>(</span><span class=n>PRIMARY_ATTRIBUTE</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>bd</span><span class=o>.</span><span class=na>setPrimary</span><span class=o>(</span><span class=n>TRUE_VALUE</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>ele</span><span class=o>.</span><span class=na>getAttribute</span><span class=o>(</span><span class=n>PRIMARY_ATTRIBUTE</span><span class=o>)));</span>
    <span class=o>}</span>

    <span class=c1>// 解析 init-method 属性
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>ele</span><span class=o>.</span><span class=na>hasAttribute</span><span class=o>(</span><span class=n>INIT_METHOD_ATTRIBUTE</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>String</span> <span class=n>initMethodName</span> <span class=o>=</span> <span class=n>ele</span><span class=o>.</span><span class=na>getAttribute</span><span class=o>(</span><span class=n>INIT_METHOD_ATTRIBUTE</span><span class=o>);</span>
        <span class=n>bd</span><span class=o>.</span><span class=na>setInitMethodName</span><span class=o>(</span><span class=n>initMethodName</span><span class=o>);</span>
    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>defaults</span><span class=o>.</span><span class=na>getInitMethod</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>bd</span><span class=o>.</span><span class=na>setInitMethodName</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>defaults</span><span class=o>.</span><span class=na>getInitMethod</span><span class=o>());</span>
        <span class=n>bd</span><span class=o>.</span><span class=na>setEnforceInitMethod</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=c1>// 解析 destroy-method 属性
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>ele</span><span class=o>.</span><span class=na>hasAttribute</span><span class=o>(</span><span class=n>DESTROY_METHOD_ATTRIBUTE</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>String</span> <span class=n>destroyMethodName</span> <span class=o>=</span> <span class=n>ele</span><span class=o>.</span><span class=na>getAttribute</span><span class=o>(</span><span class=n>DESTROY_METHOD_ATTRIBUTE</span><span class=o>);</span>
        <span class=n>bd</span><span class=o>.</span><span class=na>setDestroyMethodName</span><span class=o>(</span><span class=n>destroyMethodName</span><span class=o>);</span>
    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>defaults</span><span class=o>.</span><span class=na>getDestroyMethod</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>bd</span><span class=o>.</span><span class=na>setDestroyMethodName</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>defaults</span><span class=o>.</span><span class=na>getDestroyMethod</span><span class=o>());</span>
        <span class=n>bd</span><span class=o>.</span><span class=na>setEnforceDestroyMethod</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=c1>// 解析 factory-method 属性
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>ele</span><span class=o>.</span><span class=na>hasAttribute</span><span class=o>(</span><span class=n>FACTORY_METHOD_ATTRIBUTE</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>bd</span><span class=o>.</span><span class=na>setFactoryMethodName</span><span class=o>(</span><span class=n>ele</span><span class=o>.</span><span class=na>getAttribute</span><span class=o>(</span><span class=n>FACTORY_METHOD_ATTRIBUTE</span><span class=o>));</span>
    <span class=o>}</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>ele</span><span class=o>.</span><span class=na>hasAttribute</span><span class=o>(</span><span class=n>FACTORY_BEAN_ATTRIBUTE</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>bd</span><span class=o>.</span><span class=na>setFactoryBeanName</span><span class=o>(</span><span class=n>ele</span><span class=o>.</span><span class=na>getAttribute</span><span class=o>(</span><span class=n>FACTORY_BEAN_ATTRIBUTE</span><span class=o>));</span>
    <span class=o>}</span>

    <span class=k>return</span> <span class=n>bd</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><h4 id=213-解析-beanbean-内部的子元素>2.1.3 解析 <code>&lt;bean>...&lt;/bean> </code>内部的子元素</h4><p><bean>&mldr;&mldr;</bean> 内部的子元素有，<code>meta</code>,<code>lookup-method</code>,<code>replace-method</code>,<code>constructor-arg</code>,<code>property</code>,<code>qualifier</code>。这里我没有做深入研究，小伙伴们想要深入了解可以参考以下博文，讲解的很详细。</p><ul><li><a href="http://cmsblogs.com/?p=2754" target=_blank rel="noopener noreffer">IOC 之解析 bean 标签：constructor-arg、property 子元素</a></li><li><a href="http://cmsblogs.com/?p=2736" target=_blank rel="noopener noreffer">IOC 之解析 bean 标签：meta、lookup-method、replace-method</a></li></ul><h2 id=3-decoratebeandefinitionifrequired方法分析>3 <code>decorateBeanDefinitionIfRequired</code>方法分析</h2><p>　<code>decorateBeanDefinitionIfRequired(ele, bdHolder)</code>方法，作用是解析默认标签中的自定义标签元素。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>//BeanDefinitionParserDelegate.java
</span><span class=c1></span>
<span class=kd>public</span> <span class=n>BeanDefinitionHolder</span> <span class=nf>decorateBeanDefinitionIfRequired</span><span class=o>(</span><span class=n>Element</span> <span class=n>ele</span><span class=o>,</span> <span class=n>BeanDefinitionHolder</span> <span class=n>originalDef</span><span class=o>)</span> <span class=o>{</span>
		<span class=k>return</span> <span class=n>decorateBeanDefinitionIfRequired</span><span class=o>(</span><span class=n>ele</span><span class=o>,</span> <span class=n>originalDef</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
	<span class=o>}</span>
	
<span class=kd>public</span> <span class=n>BeanDefinitionHolder</span> <span class=nf>decorateBeanDefinitionIfRequired</span><span class=o>(</span>
			<span class=n>Element</span> <span class=n>ele</span><span class=o>,</span> <span class=n>BeanDefinitionHolder</span> <span class=n>originalDef</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>BeanDefinition</span> <span class=n>containingBd</span><span class=o>)</span> <span class=o>{</span>

		<span class=n>BeanDefinitionHolder</span> <span class=n>finalDefinition</span> <span class=o>=</span> <span class=n>originalDef</span><span class=o>;</span>

		<span class=c1>// Decorate based on custom attributes first.
</span><span class=c1></span>		<span class=n>NamedNodeMap</span> <span class=n>attributes</span> <span class=o>=</span> <span class=n>ele</span><span class=o>.</span><span class=na>getAttributes</span><span class=o>();</span>
		<span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>attributes</span><span class=o>.</span><span class=na>getLength</span><span class=o>();</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
			<span class=n>Node</span> <span class=n>node</span> <span class=o>=</span> <span class=n>attributes</span><span class=o>.</span><span class=na>item</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
			<span class=n>finalDefinition</span> <span class=o>=</span> <span class=n>decorateIfRequired</span><span class=o>(</span><span class=n>node</span><span class=o>,</span> <span class=n>finalDefinition</span><span class=o>,</span> <span class=n>containingBd</span><span class=o>);</span>
		<span class=o>}</span>

		<span class=c1>// Decorate based on custom nested elements.
</span><span class=c1></span>		<span class=n>NodeList</span> <span class=n>children</span> <span class=o>=</span> <span class=n>ele</span><span class=o>.</span><span class=na>getChildNodes</span><span class=o>();</span>
		<span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>children</span><span class=o>.</span><span class=na>getLength</span><span class=o>();</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
			<span class=n>Node</span> <span class=n>node</span> <span class=o>=</span> <span class=n>children</span><span class=o>.</span><span class=na>item</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
			<span class=k>if</span> <span class=o>(</span><span class=n>node</span><span class=o>.</span><span class=na>getNodeType</span><span class=o>()</span> <span class=o>==</span> <span class=n>Node</span><span class=o>.</span><span class=na>ELEMENT_NODE</span><span class=o>)</span> <span class=o>{</span>
				<span class=n>finalDefinition</span> <span class=o>=</span> <span class=n>decorateIfRequired</span><span class=o>(</span><span class=n>node</span><span class=o>,</span> <span class=n>finalDefinition</span><span class=o>,</span> <span class=n>containingBd</span><span class=o>);</span>
			<span class=o>}</span>
		<span class=o>}</span>
		<span class=k>return</span> <span class=n>finalDefinition</span><span class=o>;</span>
	<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>这段代码的作用是，寻找自定义标签并根据自定义标签寻找命名空间处理器，并进行进一步的解析。这里没有做具体的分析，感兴趣的小伙伴可以参考其他资料。</p><h2 id=4-registerbeandefinition方法分析>4 <code>registerBeanDefinition</code>方法分析</h2><p><code>registerBeanDefinition</code>方法的作用：注册<code>BeanDefinition</code>。见如下代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>//BeanDefinitionReaderUtils.java
</span><span class=c1></span>
<span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>registerBeanDefinition</span><span class=o>(</span>
			<span class=n>BeanDefinitionHolder</span> <span class=n>definitionHolder</span><span class=o>,</span> <span class=n>BeanDefinitionRegistry</span> <span class=n>registry</span><span class=o>)</span>
			<span class=kd>throws</span> <span class=n>BeanDefinitionStoreException</span> <span class=o>{</span>

		<span class=c1>// 使用beanName做唯一标识注册
</span><span class=c1></span>		<span class=c1>// Register bean definition under primary name.
</span><span class=c1></span>		<span class=n>String</span> <span class=n>beanName</span> <span class=o>=</span> <span class=n>definitionHolder</span><span class=o>.</span><span class=na>getBeanName</span><span class=o>();</span>
		<span class=n>registry</span><span class=o>.</span><span class=na>registerBeanDefinition</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=n>definitionHolder</span><span class=o>.</span><span class=na>getBeanDefinition</span><span class=o>());</span>

		<span class=c1>// 注册所有的别名
</span><span class=c1></span>		<span class=c1>// Register aliases for bean name, if any.
</span><span class=c1></span>		<span class=n>String</span><span class=o>[]</span> <span class=n>aliases</span> <span class=o>=</span> <span class=n>definitionHolder</span><span class=o>.</span><span class=na>getAliases</span><span class=o>();</span>
		<span class=k>if</span> <span class=o>(</span><span class=n>aliases</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
			<span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>alias</span> <span class=o>:</span> <span class=n>aliases</span><span class=o>)</span> <span class=o>{</span>
				<span class=n>registry</span><span class=o>.</span><span class=na>registerAlias</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=n>alias</span><span class=o>);</span>
			<span class=o>}</span>
		<span class=o>}</span>
	<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>解析的<code>beanDefinition</code>都会被注册到<code>BeanDefinitionRegistry</code>类型的实例registry中，对于<code>beanDefinition</code>的注册分成了两部分：通过<code>beanName</code>注册和通过别名注册。</p><h3 id=41-通过beanname注册>4.1 通过<code>beanName</code>注册</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>// DefaultListableBeanFactory.java
</span><span class=c1></span>
<span class=cm>/** Whether to allow re-registration of a different definition with the same name. */</span>
<span class=kd>private</span> <span class=kt>boolean</span> <span class=n>allowBeanDefinitionOverriding</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>

<span class=cm>/** Map of bean definition objects, keyed by bean name. */</span>
<span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>BeanDefinition</span><span class=o>&gt;</span> <span class=n>beanDefinitionMap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;(</span><span class=n>256</span><span class=o>);</span>
<span class=cm>/** List of bean definition names, in registration order. */</span>
<span class=kd>private</span> <span class=kd>volatile</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>beanDefinitionNames</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=n>256</span><span class=o>);</span>
<span class=cm>/** List of names of manually registered singletons, in registration order. */</span>
<span class=kd>private</span> <span class=kd>volatile</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>manualSingletonNames</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedHashSet</span><span class=o>&lt;&gt;(</span><span class=n>16</span><span class=o>);</span>
<span class=cm>/** Cached array of bean definition names in case of frozen configuration. */</span>
<span class=nd>@Nullable</span>
<span class=kd>private</span> <span class=kd>volatile</span> <span class=n>String</span><span class=o>[]</span> <span class=n>frozenBeanDefinitionNames</span><span class=o>;</span>

<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>registerBeanDefinition</span><span class=o>(</span><span class=n>String</span> <span class=n>beanName</span><span class=o>,</span> <span class=n>BeanDefinition</span> <span class=n>beanDefinition</span><span class=o>)</span>
        <span class=kd>throws</span> <span class=n>BeanDefinitionStoreException</span> <span class=o>{</span>

    <span class=c1>// 校验 beanName 与 beanDefinition 非空
</span><span class=c1></span>    <span class=n>Assert</span><span class=o>.</span><span class=na>hasText</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=s>&#34;Bean name must not be empty&#34;</span><span class=o>);</span>
    <span class=n>Assert</span><span class=o>.</span><span class=na>notNull</span><span class=o>(</span><span class=n>beanDefinition</span><span class=o>,</span> <span class=s>&#34;BeanDefinition must not be null&#34;</span><span class=o>);</span>

    <span class=c1>// 1. 校验 BeanDefinition 。
</span><span class=c1></span>    <span class=c1>// 这是注册前的最后一次校验了，主要是对属性 methodOverrides 进行校验。
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>beanDefinition</span> <span class=k>instanceof</span> <span class=n>AbstractBeanDefinition</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>try</span> <span class=o>{</span>
            <span class=o>((</span><span class=n>AbstractBeanDefinition</span><span class=o>)</span> <span class=n>beanDefinition</span><span class=o>).</span><span class=na>validate</span><span class=o>();</span>
        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>BeanDefinitionValidationException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>BeanDefinitionStoreException</span><span class=o>(</span><span class=n>beanDefinition</span><span class=o>.</span><span class=na>getResourceDescription</span><span class=o>(),</span> <span class=n>beanName</span><span class=o>,</span>
                    <span class=s>&#34;Validation of bean definition failed&#34;</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=c1>// 2. 从缓存中获取指定 beanName 的 BeanDefinition
</span><span class=c1></span>    <span class=n>BeanDefinition</span> <span class=n>existingDefinition</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>beanDefinitionMap</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
    <span class=c1>// 3. 如果已经存在
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>existingDefinition</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
        <span class=c1>// 如果存在但是不允许覆盖，抛出异常
</span><span class=c1></span>        <span class=k>if</span> <span class=o>(!</span><span class=n>isAllowBeanDefinitionOverriding</span><span class=o>())</span> <span class=o>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>BeanDefinitionOverrideException</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=n>beanDefinition</span><span class=o>,</span> <span class=n>existingDefinition</span><span class=o>);</span>
        <span class=c1>// 覆盖 beanDefinition 大于 被覆盖的 beanDefinition 的 ROLE ，打印 info 日志
</span><span class=c1></span>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>existingDefinition</span><span class=o>.</span><span class=na>getRole</span><span class=o>()</span> <span class=o>&lt;</span> <span class=n>beanDefinition</span><span class=o>.</span><span class=na>getRole</span><span class=o>())</span> <span class=o>{</span>
            <span class=c1>// e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE
</span><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isInfoEnabled</span><span class=o>())</span> <span class=o>{</span>
                <span class=n>logger</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Overriding user-defined bean definition for bean &#39;&#34;</span> <span class=o>+</span> <span class=n>beanName</span> <span class=o>+</span>
                        <span class=s>&#34;&#39; with a framework-generated bean definition: replacing [&#34;</span> <span class=o>+</span>
                        <span class=n>existingDefinition</span> <span class=o>+</span> <span class=s>&#34;] with [&#34;</span> <span class=o>+</span> <span class=n>beanDefinition</span> <span class=o>+</span> <span class=s>&#34;]&#34;</span><span class=o>);</span>
            <span class=o>}</span>
        <span class=c1>// 覆盖 beanDefinition 与 被覆盖的 beanDefinition 不相同，打印 debug 日志
</span><span class=c1></span>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(!</span><span class=n>beanDefinition</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>existingDefinition</span><span class=o>))</span> <span class=o>{</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isDebugEnabled</span><span class=o>())</span> <span class=o>{</span>
                <span class=n>logger</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;Overriding bean definition for bean &#39;&#34;</span> <span class=o>+</span> <span class=n>beanName</span> <span class=o>+</span>
                        <span class=s>&#34;&#39; with a different definition: replacing [&#34;</span> <span class=o>+</span> <span class=n>existingDefinition</span> <span class=o>+</span>
                        <span class=s>&#34;] with [&#34;</span> <span class=o>+</span> <span class=n>beanDefinition</span> <span class=o>+</span> <span class=s>&#34;]&#34;</span><span class=o>);</span>
            <span class=o>}</span>
        <span class=c1>// 其它，打印 debug 日志
</span><span class=c1></span>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isTraceEnabled</span><span class=o>())</span> <span class=o>{</span>
                <span class=n>logger</span><span class=o>.</span><span class=na>trace</span><span class=o>(</span><span class=s>&#34;Overriding bean definition for bean &#39;&#34;</span> <span class=o>+</span> <span class=n>beanName</span> <span class=o>+</span>
                        <span class=s>&#34;&#39; with an equivalent definition: replacing [&#34;</span> <span class=o>+</span> <span class=n>existingDefinition</span> <span class=o>+</span>
                        <span class=s>&#34;] with [&#34;</span> <span class=o>+</span> <span class=n>beanDefinition</span> <span class=o>+</span> <span class=s>&#34;]&#34;</span><span class=o>);</span>
            <span class=o>}</span>
        <span class=o>}</span>
        <span class=c1>// 允许覆盖，直接覆盖原有的 BeanDefinition 到 beanDefinitionMap 中
</span><span class=c1></span>        <span class=k>this</span><span class=o>.</span><span class=na>beanDefinitionMap</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=n>beanDefinition</span><span class=o>);</span>
    <span class=c1>// 4. 如果未存在
</span><span class=c1></span>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
        <span class=c1>// 检测创建 Bean 阶段是否已经开启，如果开启了则需要对 beanDefinitionMap 进行并发控制
</span><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>hasBeanCreationStarted</span><span class=o>())</span> <span class=o>{</span>
            <span class=c1>// beanDefinitionMap 为全局变量，存在并发访问的情况
</span><span class=c1></span>            <span class=c1>// Cannot modify startup-time collection elements anymore (for stable iteration)
</span><span class=c1></span>            <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>beanDefinitionMap</span><span class=o>)</span> <span class=o>{</span>
                <span class=c1>// 添加到 BeanDefinition 到 beanDefinitionMap 中
</span><span class=c1></span>                <span class=k>this</span><span class=o>.</span><span class=na>beanDefinitionMap</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=n>beanDefinition</span><span class=o>);</span>
                <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>updatedDefinitions</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=k>this</span><span class=o>.</span><span class=na>beanDefinitionNames</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>+</span> <span class=n>1</span><span class=o>);</span>
                <span class=n>updatedDefinitions</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>beanDefinitionNames</span><span class=o>);</span>
                <span class=c1>// 添加 beanName 到 beanDefinitionNames 中
</span><span class=c1></span>                <span class=n>updatedDefinitions</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
                <span class=k>this</span><span class=o>.</span><span class=na>beanDefinitionNames</span> <span class=o>=</span> <span class=n>updatedDefinitions</span><span class=o>;</span>
                <span class=c1>// 从 manualSingletonNames 移除 beanName
</span><span class=c1></span>               <span class=n>removeManualSingletonName</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
            <span class=o>}</span>	
        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
            <span class=c1>// Still in startup registration phase
</span><span class=c1></span>            <span class=c1>// 添加到 BeanDefinition 到 beanDefinitionMap 中
</span><span class=c1></span>            <span class=k>this</span><span class=o>.</span><span class=na>beanDefinitionMap</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=n>beanDefinition</span><span class=o>);</span>
            <span class=c1>// 添加 beanName 到 beanDefinitionNames 中
</span><span class=c1></span>            <span class=k>this</span><span class=o>.</span><span class=na>beanDefinitionNames</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
            <span class=c1>// 从 manualSingletonNames 移除 beanName
</span><span class=c1></span>            <span class=k>this</span><span class=o>.</span><span class=na>manualSingletonNames</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
        <span class=o>}</span>
        
        <span class=k>this</span><span class=o>.</span><span class=na>frozenBeanDefinitionNames</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=c1>// 5. 重新设置 beanName 对应的缓存
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>existingDefinition</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>containsSingleton</span><span class=o>(</span><span class=n>beanName</span><span class=o>))</span> <span class=o>{</span>
			<span class=n>resetBeanDefinition</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
		<span class=o>}</span>
		<span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>isConfigurationFrozen</span><span class=o>())</span> <span class=o>{</span>
			<span class=n>clearByTypeCache</span><span class=o>();</span>
		<span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>这个方法真的很复杂，简要概括逻辑为：</p><ol><li>对<code> BeanDefinition</code> 进行校验，该校验也是注册过程中的最后一次校验了，主要是对 <code>AbstractBeanDefinition </code>的 <code>methodOverrides</code> 属性进行校验。注意这个与对于XML格式的校验不同。</li><li>根据 <code>beanName</code> 从缓存中获取 <code>BeanDefinition </code>对象。</li><li>如果缓存中存在，则根据 <code>allowBeanDefinitionOverriding</code> 标志来判断是否允许覆盖。如果允许则直接覆盖。否则，抛出 <code>BeanDefinitionStoreException</code> 异常。</li><li>若缓存中没有指定 <code>beanName</code> 的 <code>BeanDefinition</code>，则判断当前阶段是否已经开始了 Bean 的创建阶段。如果是，则需要对 <code>beanDefinitionMap</code> 进行加锁控制并发问题，否则直接设置即可。</li><li>若缓存中存在该 <code>beanName</code> 或者单例 bean 集合中存在该 <code>beanName</code> ，则调用 <code>#resetBeanDefinition(String beanName)</code> 方法，重置 <code>BeanDefinition </code>缓存。</li></ol><p>这段代码核心就是<code>this.beanDefinitionMap.put(beanName, beanDefinition)</code>。</p><h3 id=42-通过别名注册>4.2 通过别名注册</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>// SimpleAliasRegistry.java
</span><span class=c1></span>
<span class=cm>/** Map from alias to canonical name. */</span>
<span class=c1>// key: alias
</span><span class=c1>// value: beanName
</span><span class=c1></span><span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>aliasMap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;(</span><span class=n>16</span><span class=o>);</span>

<span class=kd>public</span> <span class=kt>void</span> <span class=nf>registerAlias</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>String</span> <span class=n>alias</span><span class=o>)</span> <span class=o>{</span>
		<span class=c1>// 校验 name 、 alias
</span><span class=c1></span>		<span class=n>Assert</span><span class=o>.</span><span class=na>hasText</span><span class=o>(</span><span class=n>name</span><span class=o>,</span> <span class=s>&#34;&#39;name&#39; must not be empty&#34;</span><span class=o>);</span>
		<span class=n>Assert</span><span class=o>.</span><span class=na>hasText</span><span class=o>(</span><span class=n>alias</span><span class=o>,</span> <span class=s>&#34;&#39;alias&#39; must not be empty&#34;</span><span class=o>);</span>
		<span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>aliasMap</span><span class=o>)</span> <span class=o>{</span>
			<span class=c1>// name 与alias 则去掉alias
</span><span class=c1></span>			<span class=k>if</span> <span class=o>(</span><span class=n>alias</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>name</span><span class=o>))</span> <span class=o>{</span>
				<span class=k>this</span><span class=o>.</span><span class=na>aliasMap</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>alias</span><span class=o>);</span>
				<span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isDebugEnabled</span><span class=o>())</span> <span class=o>{</span>
					<span class=n>logger</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;Alias definition &#39;&#34;</span> <span class=o>+</span> <span class=n>alias</span> <span class=o>+</span> <span class=s>&#34;&#39; ignored since it points to same name&#34;</span><span class=o>);</span>
				<span class=o>}</span>
			<span class=o>}</span>
			<span class=k>else</span> <span class=o>{</span>
				<span class=n>String</span> <span class=n>registeredName</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>aliasMap</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>alias</span><span class=o>);</span>
				<span class=k>if</span> <span class=o>(</span><span class=n>registeredName</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
					<span class=c1>// 相同，则 return ，无需重复注册
</span><span class=c1></span>					<span class=k>if</span> <span class=o>(</span><span class=n>registeredName</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>name</span><span class=o>))</span> <span class=o>{</span>
						<span class=c1>// An existing alias - no need to re-register
</span><span class=c1></span>						<span class=k>return</span><span class=o>;</span>
					<span class=o>}</span>
					<span class=c1>// 如果alias不允许被覆盖则抛出异常
</span><span class=c1></span>					<span class=k>if</span> <span class=o>(!</span><span class=n>allowAliasOverriding</span><span class=o>())</span> <span class=o>{</span>
						<span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Cannot define alias &#39;&#34;</span> <span class=o>+</span> <span class=n>alias</span> <span class=o>+</span> <span class=s>&#34;&#39; for name &#39;&#34;</span> <span class=o>+</span>
								<span class=n>name</span> <span class=o>+</span> <span class=s>&#34;&#39;: It is already registered for name &#39;&#34;</span> <span class=o>+</span> <span class=n>registeredName</span> <span class=o>+</span> <span class=s>&#34;&#39;.&#34;</span><span class=o>);</span>
					<span class=o>}</span>
					<span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isDebugEnabled</span><span class=o>())</span> <span class=o>{</span>
						<span class=n>logger</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;Overriding alias &#39;&#34;</span> <span class=o>+</span> <span class=n>alias</span> <span class=o>+</span> <span class=s>&#34;&#39; definition for registered name &#39;&#34;</span> <span class=o>+</span>
								<span class=n>registeredName</span> <span class=o>+</span> <span class=s>&#34;&#39; with new target name &#39;&#34;</span> <span class=o>+</span> <span class=n>name</span> <span class=o>+</span> <span class=s>&#34;&#39;&#34;</span><span class=o>);</span>
					<span class=o>}</span>
				<span class=o>}</span>
				<span class=c1>// 校验，是否存在循环指向。如：当A-&gt;B存在时，若再次出现A-&gt;C-&gt;B时候则会抛出异常
</span><span class=c1></span>				<span class=n>checkForAliasCircle</span><span class=o>(</span><span class=n>name</span><span class=o>,</span> <span class=n>alias</span><span class=o>);</span>
				<span class=c1>// 注册 alias
</span><span class=c1></span>				<span class=k>this</span><span class=o>.</span><span class=na>aliasMap</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>alias</span><span class=o>,</span> <span class=n>name</span><span class=o>);</span>
				<span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isTraceEnabled</span><span class=o>())</span> <span class=o>{</span>
					<span class=n>logger</span><span class=o>.</span><span class=na>trace</span><span class=o>(</span><span class=s>&#34;Alias definition &#39;&#34;</span> <span class=o>+</span> <span class=n>alias</span> <span class=o>+</span> <span class=s>&#34;&#39; registered for name &#39;&#34;</span> <span class=o>+</span> <span class=n>name</span> <span class=o>+</span> <span class=s>&#34;&#39;&#34;</span><span class=o>);</span>
				<span class=o>}</span>
			<span class=o>}</span>
		<span class=o>}</span>
	<span class=o>}</span>
</code></pre></td></tr></table></div></div><p><code>checkForAliasCircle</code>方法来对别名进行了<strong>循环</strong>检测。代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>//SimpleAliasRegistry.java
</span><span class=c1></span>
<span class=kd>protected</span> <span class=kt>void</span> <span class=nf>checkForAliasCircle</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>String</span> <span class=n>alias</span><span class=o>)</span> <span class=o>{</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>hasAlias</span><span class=o>(</span><span class=n>alias</span><span class=o>,</span> <span class=n>name</span><span class=o>))</span> <span class=o>{</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Cannot register alias &#39;&#34;</span> <span class=o>+</span> <span class=n>alias</span> <span class=o>+</span>
                <span class=s>&#34;&#39; for name &#39;&#34;</span> <span class=o>+</span> <span class=n>name</span> <span class=o>+</span> <span class=s>&#34;&#39;: Circular reference - &#39;&#34;</span> <span class=o>+</span>
                <span class=n>name</span> <span class=o>+</span> <span class=s>&#34;&#39; is a direct or indirect alias for &#39;&#34;</span> <span class=o>+</span> <span class=n>alias</span> <span class=o>+</span> <span class=s>&#34;&#39; already&#34;</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
<span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>hasAlias</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>String</span> <span class=n>alias</span><span class=o>)</span> <span class=o>{</span>
    <span class=k>for</span> <span class=o>(</span><span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>entry</span> <span class=o>:</span> <span class=k>this</span><span class=o>.</span><span class=na>aliasMap</span><span class=o>.</span><span class=na>entrySet</span><span class=o>())</span> <span class=o>{</span>
        <span class=n>String</span> <span class=n>registeredName</span> <span class=o>=</span> <span class=n>entry</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>registeredName</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>name</span><span class=o>))</span> <span class=o>{</span>
            <span class=n>String</span> <span class=n>registeredAlias</span> <span class=o>=</span> <span class=n>entry</span><span class=o>.</span><span class=na>getKey</span><span class=o>();</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>registeredAlias</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>alias</span><span class=o>)</span> <span class=o>||</span> <span class=n>hasAlias</span><span class=o>(</span><span class=n>registeredAlias</span><span class=o>,</span> <span class=n>alias</span><span class=o>))</span> <span class=o>{</span>
                <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span>
    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><h2 id=5-通知监听器解析及注册完成>5 　通知监听器解析及注册完成</h2><p>通过代码<code>getReaderContext().fireComponentRegistered(new BeanComponentDefinition(bdHolder))</code>完成此工作，这里的实现只为扩展，前在Spring中并没有对此事件做任何逻辑处理。当开发人员需要对注册<code>BeanDefinition</code>事件进行监听时可以注册监听器,将处理逻辑写入监听器中。</p><h2 id=参考>参考</h2><ul><li><p><a href=https://book.douban.com/subject/25866350/ target=_blank rel="noopener noreffer">《Spring 源码深度解析》- 郝佳著</a></p></li><li><p><a href="http://cmsblogs.com/?p=2763" target=_blank rel="noopener noreffer">IOC 之注册解析的 <code>BeanDefinition</code></a></p></li><li><p><a href="http://cmsblogs.com/?p=2731" target=_blank rel="noopener noreffer">IOC 之解析 bean 标签：开启解析进程</a></p></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>本文于 2020-04-19 更新</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/ioc-load-beandefinitions-2/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://cool-sen.github.io/posts/ioc-load-beandefinitions-2/ data-title=Spring-IOC-默认标签的解析><i class="fab fa-weibo fa-fw"></i></a><a href=javascript:void(0); title="分享到 百度" data-sharer=baidu data-url=https://cool-sen.github.io/posts/ioc-load-beandefinitions-2/ data-title=Spring-IOC-默认标签的解析><i class="loveit it-baidu-fill"></i></a><a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://cool-sen.github.io/posts/ioc-load-beandefinitions-2/ data-title=Spring-IOC-默认标签的解析><i class="fab fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/spring>Spring</a>,&nbsp;<a href=/tags/ioc>IOC</a></section><section><span><a href=javascript:window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/bak/template/ class=prev rel=prev title=demo><i class="fas fa-angle-left fa-fw"></i>demo</a>
<a href=/posts/ioc-get-bean-1/ class=next rel=next title="﻿Spring-IoC -加载 Bean-总览">﻿Spring-IoC -加载 Bean-总览<i class="fas fa-angle-right fa-fw"></i></a></div></div><div class=comment><div id=valine></div><script>document.addEventListener("DOMContentLoaded",function(event){new Valine({el:'#valine',appId:'EVeKQGJoyzwUXAUhbwnrWRef-gzGzoHsz',appKey:'YMah0NIRauENVCUV8o5vhPMN',placeholder:'说点什么吧...',verify:true,avatar:'mm',pageSize:10,lang:'en',visitor:true,recordIP:true,});});</script><noscript>Please enable JavaScript to view the <a href=https://valine.js.org/>comments powered by Valine.</a></noscript></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line>由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer"><i class="far fa-heart fa-fw"></i>LoveIt</a></div><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>shuaisenma</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><a href=# class="dynamic-to-top animated faster" id=dynamic-to-top><i class="fas fa-chevron-up fa-fw"></i></a><script>document.addEventListener('DOMContentLoaded',function(){lightGallery(document.getElementById('content'),{selector:'.lightgallery',speed:400,hideBarsDelay:2000,thumbnail:true,exThumbImage:'data-thumbnail',thumbWidth:80,thumbContHeight:80,});});</script><link rel=stylesheet href=/lib/valine/valine.css><link rel=stylesheet href=/lib/iconfont/iconfont.min.css><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><script src=https://cdn.staticfile.org/valine/1.3.10/Valine.min.js></script><script src=https://cdn.staticfile.org/smooth-scroll/16.1.0/smooth-scroll.polyfills.min.js></script><script src=https://cdn.staticfile.org/lazysizes/5.2.0/lazysizes.min.js></script><script src=/lib/sharer/sharer.min.js></script><script src=/lib/lightgallery/lightgallery.min.js></script><script src=/lib/lightgallery/lg-thumbnail.min.js></script><script src=/lib/lightgallery/lg-zoom.min.js></script><script src=/js/theme.min.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-105751499-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>